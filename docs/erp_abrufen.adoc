ifdef::env-github[]
:imagesdir: https://github.com/gematik/api-erp/raw/master/images
endif::[]
:toc: macro
:toclevels: 3
:toc-title: Inhaltsverzeichnis
:numbered:

image:gematik_logo.jpg[width=35%] 

= E-Rezept API Dokumentation für Apotheker
Hier dokumentiert die gematik die Nutzung der Schnittstellen rund um das E-Rezept aus Sicht des abgebenden Leistungserbringers. 

toc::[]

==  Anwendungsfall E-Rezept beliefern
Mit diesem UseCase beliefert ein Apotheker ein E-Rezept, das auf dem E-Rezept-Fachdienst bereitliegt. Eine Unterscheidung zwischen einer Filial- oder Versandapotheke ist dabei zweitrangig, da der Unterschied im Ablauf lediglich in der Übermittlung der `Task-ID` und des `AccessCodes` durch den Versicherten besteht. 
Mit der Bekanntmachung der `Task-ID` und des `AccessCodes` durch den Versicherten mittels Präsentation eines QR-Codes oder via Kommunikationsnachricht liegen im Apothekenverwaltungssystem (AVS) alle notwendigen Parameter für den Abruf des Rezepts vor. +
Ist der Task inkl. des E-Rezept-Bundles heruntergeladen, prüft das AVS die Signatur des E-Rezept-Bundles mit Hilfe des Konnektors.
Ist das E-Rezept-Bundle gültig signiert und das E-Rezept beliefert, erfolgt der Abschluss der Transaktion mit dem Bereitstellen der Dispensierinformationen für den Versicherten.
Der E-Rezept-Fachdienst erzeugt daraufhin eine Signatur über den bearbeiteten Task und beendet den Workflow.

image:api_rezept_abrufen.png[width=100%]

NOTE: Im Ablaufdiagramm sind zusätzliche Arbeitsschritte des Apothekenpersonals wie Securpharm-Scan und Zuzahlung des Patienten nicht berücksichtigt.

== Profilierung
Für diesen Anwendungsfall werden die FHIR-Resourcen "Task": http://hl7.org/fhir/task.html und MedicationDispense https://www.hl7.org/fhir/medicationdispense.html profiliert.
Die Profile können als JSON oder XML hier eingesehen werden https://simplifier.net/e-rezept/erxtask bzw. https://simplifier.net/e-rezept/erxmedicationdispense

Die für diese Anwendung wichtigen Attribute und besonderheiten durch die Profilierung der Ressourcen werden in der folgenden Tabelle kurz Zusammengefasst: 
|===
|*Name* |*Beschreibung* 
2+s|Task
|identifier:PrescriptionID |RezeptID; eindeutig für jedes Rezept 
|identifier:KVNR |Krankenversichertennummer
|identifier:AccessCode |Vom E-Rezept Fachdienst generierter Berechtigungs-Code
|identifier:Secret |Vom E-Rezept Fachdienst generierter Berechtigungs-Code
|status |Status des E-Rezepts 
|intent |Absicht des Tasks. Fixer Wert="order"  
|authoredOn |Erstellungszeitpunkt des Tasks
|lastModified |Letzte Änderung am Task
|performerType | Institution in der das Rezept eingelöst werden soll
|input |Verweis auf die für den Patient und den Leistungserbringer gedachten Bundle
|output |Verweis auf das Quittungs-Bundle
|extension:flowType |Gibt den Typ des Rezeptes an
|extension:expiryDate |Verfallsdatum 
|extension:acceptDate |Datum bis zu welchem die Krankenkasse spätestens die Kosten übernimmt
2+s|MedicationDispense
|identifier:PrescriptionID |RezeptID; eindeutig für jedes Rezept 
|status |Status des E-Rezepts
|subject:identifier:KVNR |Krankenversichertennummer
|subject:identifier:telematikID |Telematik-ID der Apotheke, die das E-Rezept beliefert hat
|whenPrepared |Datum des Beginns der Zubereitung ei Rezepturen, bei Fertigarzneimitteln entspricht dieser Wert dem Zeitpunkt der Übergabe bzw. Herausgabe des Medikaments
|whenHandedOver |Datum der Übergabe bzw. Herausgabe an den Versicherten
|dosageInstruction |Dosierungsinformationen des Medikaments gemäß KBV-Spezifikation https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_DOSIERUNGSKENNZEICHEN falls abweichend von der ärztlichen Verordnung
|===

In den folgenden Kapiteln wird erläutert wann und wie die Befüllung dieser Attribute erfolgt.


== E-Rezept abrufen
Ein Apotheker hat vom Versicherten mitels Abscannen eines QR-Codes die Informationen `https://prescriptionserver.telematik/Task/588780/$accept?ac=777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea` für den Abruf eines E-Rezepts vom E-Rezept-Fachdienst erhalten.

[cols="a,a,a", grid="all", width="99%"]
|================
.2+^.<| image:clientsystem.png[width=100%] 
Apotheken-verwaltungssystem | HTTP-Request

--------------------------------------
curl -XPOST 
  -H "Content-Type: application/fhir+xml; charset=UTF-8;" 
  -H "Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J"
  https://prescriptionserver.telematik/Task/4711/$accept?ac=777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea
--------------------------------------

 .2+^.<| image:fachdienst.png[width=100%]
 E-Rezept-Fachdienst
| .HTTP-Response
--------------------------------------
HTTP/1.1 200 OK
Content-Type: application/fhir+xml;charset=utf-8

<Bundle xmlns="http://hl7.org/fhir">
  <id value="dffbfd6a-5712-4798-bdc8-07201eb77ab8"/>
  <meta>
    <lastUpdated value="2020-03-13T07:31:34.328+00:00"/>
  </meta>
  <type value="collection"/>
  <entry>
    <fullUrl value="https://prescriptionserver.telematik/Task/4711"/>
    <resource>
      <Task xmlns="http://hl7.org/fhir">
        <id value="4711"/>
        <meta>
          <versionId value="2"/> 
          <source value="#AsYR9plLkvONJAiv"/>
          <profile value="https://gematik.de/fhir/StructureDefinition/erxTask"/>
        </meta>
        <identifier>
          <use value="official"/>
          <system value="https://gematik.de/fhir/Namingsystem/prescriptionID"/>
          <value value="160.123.456.789.123.58"/>
        </identifier>
        <identifier>
          <use value="official"/>
          <system value="https://gematik.de/fhir/Namingsystem/accessCode"/>
          <value value="777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea"/>
        </identifier>
        <identifier>
          <use value="official"/>
          <system value="http://fhir.de/NamingSystem/gkv/kvid-10"/>
          <value value="X123456789"/>
        </identifier>
        <identifier>
          <system value="https://gematik.de/fhir/Namingsystem/secret"/>
          <value value="c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf"/> <1>
        </identifier>
        <status value="in-progress"/> <2>
        <intent value="order"/> 
        <extension url="https://gematik.de/fhir/StructureDefinition/PrescriptionType">
          <valueCodeableConcept>
            <coding>
                <system value="https://gematik.de/fhir/CodeSystem/FLOWTYPE" />
                <code value="160" />
                <display value="Muster 16 (Apothekenpflichtige Arzneimittel)" />
            </coding>
          </valueCodeableConcept>
        </extension>
        <extension url="https://gematik.de/fhir/StructureDefinition/ExpiryDate">
          <valueDateTime value="2020-06-02" />
        </extension>
        <extension url="https://example.org/fhir/StructureDefinition/AcceptDate">
          <valueDateTime value="2020-04-01" />
        </extension>
        <authoredOn value="2020-03-02T08:25:05+00:00"/>
        <lastModified value="2020-03-02T08:45:05+00:00"/>
        <performerType>
          <coding>
            <system value="http://terminology.hl7.org/CodeSystem/task-performer-type"/>
            <code value="1.2.276.0.76.4.32"/>
            <display value="Apotheke"/>
          </coding>
          <text value="Apotheke"/>
        </performerType>
        <input> 
          <type> 
            <coding> 
              <system value="https://gematik.de/fhir/CodeSystem/DOCUMENTTYPE"/> 
              <code value="1"/> 
            </coding> 
          </type> 
          <valueString value="281a985c-f25b-4aae-91a6-41ad744080b0"/> 
        </input> 
      </Task>
    </resource>
    <search>
      <mode value="outcome"/>
    </search>
  </entry>
  <entry>
    <resource>
      <Bundle xmlns="http://hl7.org/fhir"> <3>
        <id value="281a985c-f25b-4aae-91a6-41ad744080b0" />
        <meta>
          <lastUpdated value="2020-02-03T12:30:02Z" />
          <profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Bundle\|1.0.0" />
        </meta>
        <identifier>
          <system value="https://gematik.de/fhir/Namingsystem/prescriptionID" />
          <value value="160.123.456.789.123.58" />
        </identifier>
        <type value="document" />
        <timestamp value="2020-02-03T12:30:02Z" />
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Composition/ed52c1e3-b700-4497-ae19-b23744e29876" />
          <resource>
            <Composition>...</Composition>
          </resource>
        </entry>
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/MedicationRequest/e930cdee-9eb5-4b44-88b5-2a18b69f3b9a" />
          <resource>
            <MedicationRequest>...</MedicationRequest>
          </resource>
        </entry>
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Medication/5fe6e06c-8725-46d5-aecd-e65e041ca3de" />
          <resource>
            <Medication>...</Medication>
          </resource>
        </entry>
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Patient/9774f67f-a238-4daf-b4e6-679deeef3811" />
          <resource>
            <Patient>...</Patient>
          </resource>
        </entry>
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Practitioner/20597e0e-cb2a-45b3-95f0-dc3dbdb617c3" />
          <resource>
            <Practitioner>...</Practitioner>
          </resource>
        </entry>
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Organization/cf042e44-086a-4d51-9c77-172f9a972e3b" />
          <resource>
            <Organization>...</Organization>
          </resource>
        </entry>
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Coverage/1b1ffb6e-eb05-43d7-87eb-e7818fe9661a" />
          <resource>
            <Coverage>...</Coverage>
          </resource>
        </entry>
        <signature> <4>
          <type>
            <coding>
              <system value="http://hl7.org/fhir/ValueSet/signature-type" /> 
              <code value="1.2.840.10065.1.12.1.1" />
            </coding>
          </type>
          <when value="2020-02-03T12:32:00Z" />
          <who>
            <reference value="urn:uuid:20597e0e-cb2a-45b3-95f0-dc3dbdb617c3" />
          </who>
          <data>
            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
          </data>
        </signature>
      </Bundle>
    </resource>
    <search>
      <mode value="include"/>
    </search>
  </entry>
</Bundle>
--------------------------------------
<1> Dieses generierte `Secret` stellt den Zugriffscode der abrufenden Apotheke dar und muss in allen folgenden Workflowschritten angegeben werden, damit nicht eine fremde Apotheke den Prozess übernehmen kann. 
<2> Der Status des Tasks ist in Bearbeitung (`in-progress`)
<3> Dieses Element enthält das signierte E-Rezept-Bundle und ist hier gekürzt dargestellt, das vollständige Beispiel findet sich hier: link:docs/erp_bereitstellen.adoc[Beschreibung zum Ablauf des Einstellens eines E-Rezepts].
<4> In diesem Element ist die Signatur des E-Rezept-Bundles enthalten, wie sie vom Konnektor des verordnenden Arztes/Zahnarztes generiert wurde. 
3.+|Der Aufruf erfolgt als http-POST-Operation mit der FHIR-Operation `$accept`. Im http-Request-Header `Authorization` muss das während der Authentisierung erhaltene ID_TOKEN als übergeben werden. Als URL-Parameter `?ac=...` muss der beim Erzeugen des Tasks generierte `AccessCode` für die Berechtigungsprüfung übergeben werden.
Im http-ResponseBody wird der referenzierte Task sowie das qualifiziert signierte E-Rezept-Bundle zurückgegeben, wobei im Task das `secret` als zusätzliches Geheimnis in einem Task.identifier generiert wird, das in allen folgenden Zugriffen durch den Apotheker mitgeteilt werden muss.
s|Code   2+s|Type Success  
|200  2+| OK +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält die angefragten Daten.#
s|Code   2+s|Type Error   
|400  2+| Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  2+|Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  2+|Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  2+|Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 2+|Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 2+|Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|409 2+|Conflict +
[small]#Die Anfrage wurde unter falschen Annahmen gestellt. Das E-Rezept befindet sich bereits in Belieferung#
|410 2+|Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 2+|Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  2+|Server Errors +
[small]#Unerwarteter Serverfehler#
|================

== Qualifizierte Signatur des E-Rezepts prüfen
Ein Apotheker hat ein E-Rezept abgerufen ...

[cols="a,a,a", grid="all", width="99%"]
|================
.2+^.<| image:clientsystem.png[width=100%] 
Apotheken-verwaltungssystem | HTTP-Request
--------------------------------------
curl -XPOST -H "Content-Type: text/xml; charset=UTF-8" -H "Content-Length: 1234" 
  -H "SOAPAction: \"http://ws.gematik.de/conn/SignatureService/v7.4#VerifyDocument\"" --data 
"<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<S:Envelope xmlns:S=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\">
  <SOAP-ENV:Header/>
  <S:Body>
    <ns10:VerifyDocument 
      xmlns=\"http://www.w3.org/2001/04/xmlenc#\" 
      xmlns:ns10=\"http://ws.gematik.de/conn/SignatureService/v7.4\" 
      xmlns:ns11=\"urn:oasis:names:tc:dss-x:1.0:profiles:SignaturePolicy:schema#\" 
      xmlns:ns12=\"http://ws.gematik.de/conn/ConnectorContext/v2.0\" xmlns:ns13=\"urn:oasis:names:tc:SAML:2.0:assertion\" 
      xmlns:ns14=\"urn:oasis:names:tc:SAML:1.0:assertion\" 
      xmlns:ns2=\"http://www.w3.org/2000/09/xmldsig#\" 
      xmlns:ns3=\"http://ws.gematik.de/conn/CertificateServiceCommon/v2.0\" 
      xmlns:ns4=\"http://uri.etsi.org/01903/v1.3.2#\" 
      xmlns:ns5=\"urn:oasis:names:tc:dss:1.0:core:schema\" 
      xmlns:ns6=\"urn:oasis:names:tc:dss-x:1.0:profiles:verificationreport:schema#\" 
      xmlns:ns7=\"http://uri.etsi.org/02231/v2#\" 
      xmlns:ns8=\"http://ws.gematik.de/conn/ConnectorCommon/v5.0\" 
      xmlns:ns9=\"http://ws.gematik.de/tel/error/v2.0\">
      <ns12:Context>
        <ns8:MandantId>Mandant1</ns8:MandantId>
        <ns8:ClientSystemId>Clientsystem1</ns8:ClientSystemId>
        <ns8:WorkplaceId>Arbeitsplatz1</ns8:WorkplaceId>
        <ns8:UserId>Möller</ns8:UserId>
      </ns12:Context>
      <ns10:TvMode>NONE</ns10:TvMode>
      <ns10:OptionalInputs>
        <ns6:ReturnVerificationReport>
          <ns6:IncludeVerifier>false</ns6:IncludeVerifier>
          <ns6:IncludeCertificateValues>true</ns6:IncludeCertificateValues>
          <ns6:IncludeRevocationValues>true</ns6:IncludeRevocationValues>
          <ns6:ExpandBinaryValues>false</ns6:ExpandBinaryValues>
          <ns6:ReportDetailLevel>urn:oasis:names:tc:dss-x:1.0:profiles:verificationreport:reportdetail:allDetails</ns6:ReportDetailLevel>
        </ns6:ReturnVerificationReport>
      </ns10:OptionalInputs>
      <ns10:SignatureObject>
          <ns5:Base64Signature 
            Type=\"urn:ietf:rfc:5652\">MIAGCSqGSIb3DQEHAqCAMIA...A=</ns5:Base64Signature> <1>
        </ns10:SignatureObject>
      <ns10:IncludeRevocationInfo>false</ns10:IncludeRevocationInfo>
    </ns10:VerifyDocument>
  </S:Body>
</S:Envelope>"
https://192.168.x.y/Konnektorservice
--------------------------------------
<1> Dieses Element enthält das signierte Dokument inkl. Signatur als PKCS#7-Datei in HEX-codierung, das zu prüfen ist.

 .2+^.<| image:konnektor.png[width=100%]
 Konnektor
| HTTP-Response
--------------------------------------


ZULIEFERUNG VON BEISPIEL-RESPONSE ERFORDERLICH





--------------------------------------

3.+|Der Aufruf erfolgt als http-POST-Operation auf eine SOAP-Schnittstelle. 
s|Code   2+s|Type Success  
|200  2+|OK  +
[small]#Die Anfrage wurde erfolgreich bearbeitet und das Ergebnis der Anfrage wird in der Antwort übertragen. Das gilt ebenso für Fehler in der Verarbeitung des SOAP-Requests, die als SOAP-Fault zurückgemeldet werden.#
s|Code   2+s|Type Error   
|400  2+| Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|================

== E-Rezept-Abgabe vollziehen
Ein Apotheker hat ein E-Rezept abgerufen und beliefert den Patienten mit dem Medikament. Zum Abschluss des Worflows stellt er dem Versicherten Informationen über das abgegebene Medikament bereit und erhält als Ergebnis eine signierte Quittung, die er in seinen Abrechnungsprozessen gegenüber dem Abrechnungszentrum bzw. der Krankenkasse als Nachweis des ordnungsgemäßen Abschlusses der Transaktion verwenden kann.

[cols="a,a,a", grid="all", width="99%"]
|================
.2+^.<| image:clientsystem.png[width=100%] 
Apotheken-verwaltungssystem | .HTTP-Request

--------------------------------------
curl -XPOST 
  -H "Content-Type: application/fhir+xml; charset=UTF-8;"
  -H "Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J" <1>
  https://prescriptionserver.telematik/Task/4711/$close?secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf <2>
<MedicationDispense xmlns="http://hl7.org/fhir">  <3>
  <meta>
    <profile value="https://gematik.de/fhir/StructureDefinition/erxMedicationDispense" />
  </meta>
  <contained> 
    <Medication> <4>
      <id value="med0314"/> 
      <meta>
        <profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Medikament_PZN\|1.0.0" />
      </meta>
      <extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_MEDIKAMENT_KATEGORIE">
        <valueCoding>
          <system value="https://fhir.kbv.de/CodeSystem/KBV_CS_MEDIKAMENT_KATEGORIE" />
          <code value="00" />
        </valueCoding>
      </extension>
      <extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_MEDIKAMENT_IMPFSTOFF">
        <valueBoolean value="false" />
      </extension>
      <extension url="http://fhir.de/StructureDefinition/normgroesse">
        <valueCode value="N1" />
      </extension>
      <code>
        <coding>
          <system value="http://fhir.de/CodeSystem/ifa/pzn" />
          <code value="06313728" />
        </coding>
        <text value="Sumatriptan-1a Pharma 100 mg Tabletten" />
      </code>
      <form>
        <coding>
          <system value="KBV_CS_SFHIR_KBV_DARREICHUNGSFORM" />
          <code value="TAB" />
        </coding>
      </form>
      <amount>
        <numerator>
          <value value="12" />
          <system value="http://unitsofmeasure.org" />
          <code value="{tbl}" />
        </numerator>
        <denominator>
          <value value="1" />
        </denominator>
      </amount> 
    </Medication> 
  </contained> 
  <status value="completed"/> 
  <medicationReference> 
    <reference value="#med0314"/> 
    <display value="Sumatriptan-1a Pharma 100 mg Tabletten"/> 
  </medicationReference>
  <whenPrepared value="2020-03-20T07:13:00+05:00"/> 
  <whenHandedOver value="2020-03-20T07:13:00+05:00"/> <5>
  <dosageInstruction>
    <extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_DOSIERUNGSKENNZEICHEN">
      <valueBoolean value="true" />
    </extension>
    <text value="1-0-1-0" /> <6>
  </dosageInstruction> 
</MedicationDispense> 
--------------------------------------
<1> Mit dem ID-Token im `Authorization`-Header weist sich der Zugreifende als Apotheker aus, im Token ist seine Rolle enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.
<2> Zum Nachweis als berechtigte Apotheke, die das E-Rezept gerade in Bearbeitung hält, muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden
<3> Mit der Übergabe der MedicationDispense signalisiert der Apotheker den Abschluss des E-Rezept-Workflows. Der Versicherte erhält Informationen über das abgegebene Medikament.
<4> Sofern kein Austausch des verordneten Medikaments erfolgte, können die Medikations-Informationen aus dem E-Rezept übernommen werden, beim Austausch gegen ein anderes Medikament müssen hier die entsprechenden Informationen angepasst werden, ebenso etwaig abweichende Dosierinformationen.
<5> Die Zeitangabe bezieht sich auf die Übergabe des Medikaments, wann wurde es dem Überbringer des E-Rezepts ausgehändigt.
<6> Die Codierung der Einnahmehinweise erfolgt gemäß des KBV-Schemas [morgens-mittags-abends-nachts] in boolescher Notation 1=ja, 0=nein
 .2+^.<| image:fachdienst.png[width=100%]
 E-Rezept-Fachdienst
| .HTTP-Response
--------------------------------------
HTTP/1.1 200 OK
<Bundle xmlns="http://hl7.org/fhir"> <1>
  <id value="dffbfd6a-5712-4798-bdc8-07201eb77ab8"/>
  <meta>
    <lastUpdated value="2020-03-20T07:31:34.328+00:00"/>
    <profile value="https://gematik.de/fhir/StructureDefinition/erxReceipt" />
  </meta>
  <identifier>
    <use value="official"/>
    <system value="https://gematik.de/fhir/Namingsystem/prescriptionID"/>
    <value value="160.123.456.789.123.58"/> <2>
  </identifier>
  <type value="document"/>
  <timestamp value="2020-03-20T07:31:34.328+00:00" />
  <entry>
    <fullUrl value="https://gematik.de/fhir/erxComposition/e002e972-fa62-4dee-a650-23575c0f8701" />
    <resource>
      <Composition>
        <id value="e002e972-fa62-4dee-a650-23575c0f8701" />
        <meta>
          <profile value="https://gematik.de/fhir/StructureDefinition/erxComposition" />
        </meta>
        <status value="final" />
        <type>
          <code>
            <coding>
              <system value="https://gematik.de/fhir/CodeSystem/DOCUMENTTYPE" />
              <code value="3" />
            </coding>
          </code>
        </type>
        <date value="2020-03-20T07:31:34.328+00:00" />
        <author>
          <reference value="urn:uuid:6b007bdf-c50a-4e69-9db2-6c67092057f6" />
        </author>
        <title value="Quittung E-Rezept-Belieferung" />
        <subject>
          <reference value="urn:uuid:281a985c-f25b-4aae-91a6-41ad744080b0" />
        </subject>
        <section>
          <code>
            <coding>
              <system value="https://gematik.de/fhir/CodeSystem/DOCUMENTTYPE" />
              <code value="3" />
            </coding>
          </code>
          <entry>
            <reference value="4711" />
          </entry>
        </section>
      </Composition>
    </resource>
  </entry>  
  <entry>
    <resource>
      <Device xmlns="http://hl7.org/fhir"> <3>
      <id value="6b007bdf-c50a-4e69-9db2-6c67092057f6"/>
      <meta>
        <profile value="https://gematik.de/fhir/StructureDefinition/erxDevice"/>
        </meta>
        <status value="active"/>
        <serialNumber value="R4.0.0.287342834"/>
      </Device>  
    </resource>
    <fullUrl value="https://prescriptionserver.telematik/Task/4711"/>
    <resource>
      <Task> <4>
        <id value="4711"/>
        <meta>
          <versionId value="2"/>
          <lastUpdated value="2020-02-18T10:05:05.038+00:00"/>
          <profile value="https://gematik.de/fhir/StructureDefinition/erxTask"/>
        </meta>
        <identifier>
          <use value="official"/>
          <system value="https://gematik.de/fhir/Namingsystem/prescriptionID"/>
          <value value="160.123.456.789.123.58"/>
        </identifier>
        <identifier>
          <use value="official"/>
          <system value="https://gematik.de/fhir/Namingsystem/accessCode"/>
          <value value="777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea"/>
        </identifier>
        <identifier>
          <use value="official"/>
          <system value="http://fhir.de/NamingSystem/gkv/kvid-10"/>
          <value value="X123456789"/>
        </identifier>
        <identifier>
          <system value="https://gematik.de/fhir/Namingsystem/secret"/>
          <value value="c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf"/>
        </identifier>
        <status value="in-progress"/>
        <intent value="order"/> 
        <extension url="https://gematik.de/fhir/StructureDefinition/PrescriptionType">
          <valueCodeableConcept>
            <coding>
                <system value="https://gematik.de/fhir/CodeSystem/FLOWTYPE" />
                <code value="160" />
                <display value="Muster 16 (Apothekenpflichtige Arzneimittel)" />
            </coding>
          </valueCodeableConcept>
        </extension>
        <extension url="https://gematik.de/fhir/StructureDefinition/ExpiryDate">
          <valueDateTime value="2020-06-02" />
        </extension>
        <extension url="https://example.org/fhir/StructureDefinition/AcceptDate">
          <valueDateTime value="2020-04-01" />
        </extension>
        <authoredOn value="2020-03-02T08:25:05+00:00"/>
        <lastModified value="2020-03-02T08:45:05+00:00"/>
        <performerType>
          <coding>
            <system value="http://terminology.hl7.org/CodeSystem/task-performer-type"/>
            <code value="1.2.276.0.76.4.32"/>
            <display value="Apotheke"/>
          </coding>
          <text value="Apotheke"/>
        </performerType>
        <input> 
          <type> 
            <coding> 
              <system value="https://gematik.de/fhir/CodeSystem/DOCUMENTTYPE"/> 
              <code value="1"/> 
            </coding> 
          </type> 
          <valueString value="281a985c-f25b-4aae-91a6-41ad744080b0"/> 
        </input> 
      </Task>
    </resource>
  </entry>
  <entry>
    <resource>
      <Bundle xmlns="http://hl7.org/fhir"> <5>
        <id value="281a985c-f25b-4aae-91a6-41ad744080b0" />
        <meta>
          <lastUpdated value="2020-02-03T12:30:02Z" />
          <profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Bundle\|1.0.0" />
        </meta>
        <identifier>
          <system value="https://gematik.de/fhir/Namingsystem/prescriptionID" />
          <value value="160.123.456.789.123.58" />
        </identifier>
        <type value="document" />
        <timestamp value="2020-02-03T12:30:02Z" />
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Composition/ed52c1e3-b700-4497-ae19-b23744e29876" />
          <resource>
            <Composition>...</Composition>
          </resource>
        </entry>
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/MedicationRequest/e930cdee-9eb5-4b44-88b5-2a18b69f3b9a" />
          <resource>
            <MedicationRequest>...</MedicationRequest>
          </resource>
        </entry>
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Medication/5fe6e06c-8725-46d5-aecd-e65e041ca3de" />
          <resource>
            <Medication>...</Medication>
          </resource>
        </entry>
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Patient/9774f67f-a238-4daf-b4e6-679deeef3811" />
          <resource>
            <Patient>...</Patient>
          </resource>
        </entry>
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Practitioner/20597e0e-cb2a-45b3-95f0-dc3dbdb617c3" />
          <resource>
            <Practitioner>...</Practitioner>
          </resource>
        </entry>
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Organization/cf042e44-086a-4d51-9c77-172f9a972e3b" />
          <resource>
            <Organization>...</Organization>
          </resource>
        </entry>
        <entry>
          <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Coverage/1b1ffb6e-eb05-43d7-87eb-e7818fe9661a" />
          <resource>
            <Coverage>...</Coverage>
          </resource>
        </entry>
        <signature>
          <type>
            <coding>
              <system value="http://hl7.org/fhir/ValueSet/signature-type" /> 
              <code value="1.2.840.10065.1.12.1.1" />
            </coding>
          </type>
          <when value="2020-02-03T12:32:00Z"/>
          <who>
            <reference value="urn:uuid:20597e0e-cb2a-45b3-95f0-dc3dbdb617c3" />
          </who>
          <data>
            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
          </data>
        </signature>
      </Bundle>
    </resource>
  </entry>
  <signature>
    <type>
      <coding>
        <system value="http://hl7.org/fhir/ValueSet/signature-type" /> 
        <code value="1.2.840.10065.1.12.1.5" />
      </coding>
    </type>
    <when value="2020-03-20T07:31:34.328+00:00"/>
    <who>
      <reference value="urn:uuid:6b007bdf-c50a-4e69-9db2-6c67092057f6" />
    </who>
    <data> <6>
      QXVmZ3J1bmQgZGVyIENvcm9uYS1TaXR1YXRpb24ga29ubnRlIGhpZXIga3VyemZyaXN0aWcga2VpbiBCZWlzcGllbCBpbiBkZXIgTGFib3J1bWdlYnVuZyBkZXIgZ2VtYXRpayBlcnN0ZWxsdCB3ZWRlbi4gRGllc2VzIHdpcmQgbmFjaGdlcmVpY2h0LgoKSW5oYWx0bGljaCB1bmQgc3RydWt0dXJlbGwgaXN0IGRpZSBTZXJ2ZXJzaWduYXR1ciBkZXIgUXVpdHR1bmcgZWluZSBFbnZlbG9waW5nIENBZEVTLVNpZ25hdHVyLCBkaWUgZGVuIHNpZ25pZXJ0ZW4gRGF0ZW5zYXR6IGFuYWxvZyB6dXIgS29ubmVrdG9yLVNpZ25hdHVyIGlubmVyaGFsYiBkZXMgQVNOMS5Db250YWluZXJzIHRyYW5zcG9ydGllcnQu
    </data>
  </signature>
</Bundle>

--------------------------------------
<1> Im Ergebnis der Operation wird ein signiertes Bundle als Nachweis des ordnungsgemäßen Durchlaufs des E-Rezept-Workflows und Abschluss des referenzierten Tasks zurückgegeben.
<2> Das signierte Quittungs-Bundle enthält die Rezept-ID für eine eindeutige Zuordnung aller Artefakte des durchlaufenen Workflows
<3> Das hier eingebettete Device identifiziert den E-Rezept-Fachdienst als Aussteller der Quittung.
<4> Ebenso ist der Task enthalten, der mit diesem Prozessschritt beendet wird.
<5> Der Vollständigkeit halber ist das signierte E-Rezept-Bundle noch einmal enthalten und wird ebenso und vollständig in die Signatur des Quittungs-Bundles mit einbezogen
<6> Dieses Element enthält die Signatur des Quittungs-Bundles über alle enthaltenen Objekte (Device, Task, signiertes E-Rezept-Bundle) als Enveloping CAdES-Signatur in Base64-Codierung.
3.+|Der Aufruf erfolgt als http-POST-Operation mit der FHIR-Operation `$close`. Im http-Request-Header `Authorization` muss das während der Authentisierung erhaltene ID_TOKEN als übergeben werden. Als URL-Parameter `?secret=...` muss das beim Abrufen des E-Rezepts im Task generierte `Secret` für die Berechtigungsprüfung übergeben werden. Zusätzlich werden Informationen über das ausgegebene Medikament an den Fachdienst übergeben.
Im http-ResponseBody wird die serverseitig über den Task und das E-Rezept-Bundle erzeugte Signatur als `Quittungs-Bundle`-Ressource zurückgegeben, die dem Apotheker gegenüber der Krankenkasse als Quittung dient.
s|Code   2+s|Type Success  
|200  2+| OK +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die angeforderte Ressource wurde vor dem Senden der Antwort erstellt. Das „Location“-Header-Feld enthält die Adresse der erstellten Ressource.#
s|Code   2+s|Type Error   
|400  2+| Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  2+|Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  2+|Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  2+|Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 2+|Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 2+|Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|409 2+|Conflict +
[small]#Die Anfrage wurde unter falschen Annahmen gestellt. Das E-Rezept befindet sich bereits in Belieferung#
|410 2+|Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 2+|Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  2+|Server Errors +
[small]#Unerwarteter Serverfehler#
|================


== E-Rezept zurückweisen
Ein Apotheker hat im vorherigen Schritt ein E-Rezept abgerufen und fachlich geprüft. Er kommt zu dem Schluss, das E-Rezept nicht zu beliefern und möchte nun das E-Rezept zurückweisen, damit der Versicherte das E-Rezept ggfs. in einer anderen Apotheke einlösen kann.

[cols="a,a,a", grid="all", width="99%"]
|================
.2+^.<| image:clientsystem.png[width=100%] 
Apotheken-verwaltungssystem | .HTTP-Request

--------------------------------------
curl -XPOST 
  -H "Content-Type: application/fhir+xml; charset=UTF-8;"
  -H "Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J" <1>
  https://prescriptionserver.telematik/Task/4711/$reject?secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf <2>
--------------------------------------
<1> Mit dem ID-Token im `Authorization`-Header weist sich der Zugreifende als Apotheker aus, im Token ist seine Rolle enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.
<2> Zum Nachweis als berechtigte Apotheke, die das E-Rezept gerade in Bearbeitung hält, muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden
 .2+^.<| image:fachdienst.png[width=100%]
 E-Rezept-Fachdienst
| .HTTP-Response
--------------------------------------
HTTP/1.1 204 No Content <1>

--------------------------------------
<1> Im Ergebnis der $reject-Operation wird der referenzierte Task auf den aktiven Status `ready` zurückgesetzt und das Secret gelöscht. Dementsprechend werden keine Daten an den aufrufenden Client zurückgegeben.

3.+|Der Aufruf erfolgt als http-POST-Operation mit der FHIR-Operation `$reject`. Im http-Request-Header `Authorization` muss das während der Authentisierung erhaltene ID_TOKEN als übergeben werden. Als URL-Parameter `?secret=...` muss das beim Abrufen des E-Rezepts im Task generierte `Secret` für die Berechtigungsprüfung übergeben werden.
s|Code   2+s|Type Success  
|204  2+| No Content +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält jedoch keine Daten.#
s|Code   2+s|Type Error   
|400  2+| Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  2+|Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  2+|Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  2+|Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 2+|Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 2+|Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|410 2+|Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 2+|Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  2+|Server Errors +
[small]#Unerwarteter Serverfehler#
|================


== E-Rezept löschen
Ein Apotheker hat im vorherigen Schritt ein E-Rezept abgerufen und fachlich geprüft. Der Versicherte bittet ihn jedoch, das Rezept nicht zu beliefern sondern zu löschen, da er nicht über ein eigenes Gerät mit E-Rezept-App verfügt aber sein Recht auf informationelle Selbstbestimmung wahrnehmen möchte. Der Apotheker kommt diesem Wunsch nach und löscht das E-Rezept auf dem Fachdienst.

[cols="a,a,a", grid="all", width="99%"]
|================
.2+^.<| image:clientsystem.png[width=100%] 
Apotheken-verwaltungssystem | .HTTP-Request

--------------------------------------
curl -XPOST 
  -H "Content-Type: application/fhir+xml; charset=UTF-8;"
  -H "Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J" <1>
  https://prescriptionserver.telematik/Task/4711/$abort?secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf <2>
--------------------------------------
<1> Mit dem ID-Token im `Authorization`-Header weist sich der Zugreifende als Apotheker aus, im Token ist seine Rolle enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.
<2> Zum Nachweis als berechtigte Apotheke, die das E-Rezept gerade in Bearbeitung hält, muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden
 .2+^.<| image:fachdienst.png[width=100%]
 E-Rezept-Fachdienst
| .HTTP-Response
--------------------------------------
HTTP/1.1 204 No Content <1>

--------------------------------------
<1> Im Ergebnis der $abort-Operation wird der referenzierte Task gelöscht. Dementsprechend werden keine Daten an den aufrufenden Client zurückgegeben.

3.+|Der Aufruf erfolgt als http-POST-Operation mit der FHIR-Operation `$abort`. Im http-Request-Header `Authorization` muss das während der Authentisierung erhaltene ID_TOKEN als übergeben werden. Als URL-Parameter `?secret=...` muss das beim Abrufen des E-Rezepts im Task generierte `Secret` für die Berechtigungsprüfung übergeben werden.
s|Code   2+s|Type Success  
|204  2+| No Content +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält jedoch keine Daten.#
s|Code   2+s|Type Error   
|400  2+| Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  2+|Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  2+|Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  2+|Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 2+|Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 2+|Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|409 2+|Conflict +
[small]#Die Anfrage wurde unter falschen Annahmen gestellt. Das E-Rezept befindet sich bereits in Belieferung#
|410 2+|Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 2+|Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  2+|Server Errors +
[small]#Unerwarteter Serverfehler#
|================



== Quittung erneut abrufen
Als Apotheker kann es erforderlich sein, die Quittung für ein beliefertes E-Rezept erneut abzurufen (z.B. am Monatsende für Abrechnungszwecke, falls das Apothekenverwaltungssystem die Quittung nicht während der Belieferung gespeichert hat). Der Abruf ist möglich, solange das E-Rezept nicht automatisch und auch nicht durch den Versicherten gelöscht wurde.

[cols="a,a,a", grid="all", width="99%"]
|================
.2+^.<| image:clientsystem.png[width=100%] 
Apotheken-verwaltungssystem | .HTTP-Request

--------------------------------------
curl -XGET 
  -H "Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J" <1>
  https://prescriptionserver.telematik/Task/4711?secret= c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf <2>
--------------------------------------
<1> Mit dem ID-Token im `Authorization`-Header weist sich der Zugreifende als Apotheker aus, im Token ist seine Rolle enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.
<2> Zum Nachweis als berechtigte Apotheke, die das E-Rezept verarbeitet hat(te), muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden
 .2+^.<| image:fachdienst.png[width=100%]
 E-Rezept-Fachdienst
| .HTTP-Response
--------------------------------------
HTTP/1.1 200 
<Bundle xmlns="http://hl7.org/fhir">
  <id value="dffbfd6a-5712-4798-bdc8-07201eb77ab8"/>
  <meta>
    <lastUpdated value="2020-03-13T07:31:34.328+00:00"/>
  </meta>
  <type value="collection"/>
  <entry>
    <fullUrl value="https://prescriptionserver.telematik/Task/4711"/>
    <resource>
      <Task xmlns="http://hl7.org/fhir">
        <id value="4711"/>
        <meta>
          <versionId value="2"/>
          <lastUpdated value="2020-02-18T10:05:05.038+00:00"/>
          <source value="#AsYR9plLkvONJAiv"/>
          <profile value="https://gematik.de/fhir/StructureDefinition/erxTask"/>
        </meta>
        <identifier>
          <use value="official"/>
          <system value="https://gematik.de/fhir/Namingsystem/prescriptionID"/>
          <value value="160.123.456.789.123.58"/>
        </identifier>
        <identifier>
          <use value="official"/>
          <system value="https://gematik.de/fhir/Namingsystem/accessCode"/>
          <value value="777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea"/>
        </identifier>
        <identifier>
          <use value="official"/>
          <system value="http://fhir.de/NamingSystem/gkv/kvid-10"/>
          <value value="X123456789"/>
        </identifier>
        <identifier>
          <system value="https://gematik.de/fhir/Namingsystem/secret"/>
          <value value="c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf"/> <1>
        </identifier>
        <status value="completed"/> <2>
        <intent value="order"/> 
        <extension url="https://gematik.de/fhir/StructureDefinition/PrescriptionType">
          <valueCodeableConcept>
            <coding>
                <system value="https://gematik.de/fhir/CodeSystem/FLOWTYPE" />
                <code value="160" />
                <display value="Muster 16 (Apothekenpflichtige Arzneimittel)" />
            </coding>
          </valueCodeableConcept>
        </extension>
        <extension url="https://gematik.de/fhir/StructureDefinition/ExpiryDate">
          <valueDateTime value="2020-06-02" />
        </extension>
        <extension url="https://example.org/fhir/StructureDefinition/AcceptDate">
          <valueDateTime value="2020-04-01" />
        </extension>
        <authoredOn value="2020-03-02T08:25:05+00:00"/>
        <lastModified value="2020-03-02T08:45:05+00:00"/>
        <performerType>
          <coding>
            <system value="http://terminology.hl7.org/CodeSystem/task-performer-type"/>
            <code value="1.2.276.0.76.4.32"/>
            <display value="Apotheke"/>
          </coding>
          <text value="Apotheke"/>
        </performerType>
        <input> 
          <type> 
            <coding> 
              <system value="https://gematik.de/fhir/CodeSystem/DOCUMENTTYPE"/> 
              <code value="1"/> 
            </coding> 
          </type> 
          <valueString value="281a985c-f25b-4aae-91a6-41ad744080b0"/> 
        </input> 
        <output> 
          <type> 
            <coding> 
              <system value="https://gematik.de/fhir/CodeSystem/DOCUMENTTYPE"/> 
              <code value="3"/> 
            </coding> 
          </type> 
          <valueString value="dffbfd6a-5712-4798-bdc8-07201eb77ab8"/> 
        </output> 
      </Task>
    </resource>
    <search>
      <mode value="outcome"/>
    </search>
  </entry>
  <entry>
    <resource>
      <Bundle xmlns="http://hl7.org/fhir">
        <id value="dffbfd6a-5712-4798-bdc8-07201eb77ab8"/>
        <meta>
          <lastUpdated value="2020-03-20T07:31:34.328+00:00"/>
          <profile value="https://gematik.de/fhir/StructureDefinition/erxReceipt" />
        </meta>
        <identifier>
          <use value="official"/>
          <system value="https://gematik.de/fhir/Namingsystem/prescriptionID"/>
          <value value="160.123.456.789.123.58"/>
        </identifier>
        <type value="document"/>
        <timestamp value="2020-03-20T07:31:34.328+00:00" />
        <entry>
          <fullUrl value="https://gematik.de/fhir/erxComposition/e002e972-fa62-4dee-a650-23575c0f8701" />
          <resource>
            <Composition>
              <id value="e002e972-fa62-4dee-a650-23575c0f8701" />
              <meta>
                <profile value="https://gematik.de/fhir/StructureDefinition/erxComposition" />
              </meta>
              <status value="final" />
              <type>
                <code>
                  <coding>
                    <system value="https://gematik.de/fhir/CodeSystem/DOCUMENTTYPE" />
                    <code value="3" />
                  </coding>
                </code>
              </type>
              <date value="2020-03-20T07:31:34.328+00:00" />
              <author>
                <reference value="urn:uuid:6b007bdf-c50a-4e69-9db2-6c67092057f6" />
              </author>
              <title value="Quittung E-Rezept-Belieferung" />
              <subject>
                <reference value="urn:uuid:281a985c-f25b-4aae-91a6-41ad744080b0" />
              </subject>
              <section>
                <code>
                  <coding>
                    <system value="https://gematik.de/fhir/CodeSystem/DOCUMENTTYPE" />
                    <code value="3" />
                  </coding>
                </code>
                <entry>
                  <reference value="4711" />
                </entry>
              </section>
            </Composition>
          </resource>
        </entry>  
        <entry>
          <resource>
            <Device xmlns="http://hl7.org/fhir">
            <id value="6b007bdf-c50a-4e69-9db2-6c67092057f6"/>
            <meta>
              <profile value="https://gematik.de/fhir/StructureDefinition/erxDevice"/>
              </meta>
              <status value="active"/>
              <serialNumber value="R4.0.0.287342834"/>
            </Device>  
          </resource>
          <fullUrl value="https://prescriptionserver.telematik/Task/4711"/>
          <resource>
            <Task>
              <id value="4711"/>
              <meta>
                <versionId value="2"/>
                <lastUpdated value="2020-02-18T10:05:05.038+00:00"/>
                <profile value="https://gematik.de/fhir/StructureDefinition/erxTask"/>
              </meta>
              <identifier>
                <use value="official"/>
               <system value="https://gematik.de/fhir/Namingsystem/prescriptionID"/>
                <value value="160.123.456.789.123.58"/>
              </identifier>
              <identifier>
                <use value="official"/>
                <system value="https://gematik.de/fhir/Namingsystem/accessCode"/>
                <value value="777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea"/>
             </identifier>
              <identifier>
                <use value="official"/>
                <system value="http://fhir.de/NamingSystem/gkv/kvid-10"/>
                <value value="X123456789"/>
              </identifier>
              <identifier>
                <system value="https://gematik.de/fhir/Namingsystem/secret"/>
                <value value="c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf"/>
              </identifier>
              <status value="in-progress"/>
              <intent value="order"/> 
              <extension url="https://gematik.de/fhir/StructureDefinition/PrescriptionType">
                <valueCodeableConcept>
                  <coding>
                    <system value="https://gematik.de/fhir/CodeSystem/FLOWTYPE" />
                    <code value="160" />
                    <display value="Muster 16 (Apothekenpflichtige Arzneimittel)" />
                  </coding>
                </valueCodeableConcept>
              </extension>
              <extension url="https://gematik.de/fhir/StructureDefinition/ExpiryDate">
                <valueDateTime value="2020-06-02" />
              </extension>
              <extension url="https://example.org/fhir/StructureDefinition/AcceptDate">
                <valueDateTime value="2020-04-01" />
              </extension>
              <authoredOn value="2020-03-02T08:25:05+00:00"/>
              <lastModified value="2020-03-02T08:45:05+00:00"/>
              <performerType>
                <coding>
                  <system value="http://terminology.hl7.org/CodeSystem/task-performer-type"/>
                  <code value="1.2.276.0.76.4.32"/>
                  <display value="Apotheke"/>
                </coding>
                <text value="Apotheke"/>
              </performerType>
              <input> 
                <type> 
                  <coding> 
                    <system value="https://gematik.de/fhir/CodeSystem/DOCUMENTTYPE"/> 
                    <code value="1"/> 
                  </coding> 
                </type> 
                <valueString value="281a985c-f25b-4aae-91a6-41ad744080b0"/> 
              </input> 
            </Task>
          </resource>
        </entry>
        <entry>
          <resource>
            <Bundle xmlns="http://hl7.org/fhir">
              <id value="281a985c-f25b-4aae-91a6-41ad744080b0" />
              <meta>
                <lastUpdated value="2020-02-03T12:30:02Z" />
                <profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Bundle\|1.0.0" />
              </meta>
              <identifier>
                <system value="https://gematik.de/fhir/Namingsystem/prescriptionID" />
                <value value="160.123.456.789.123.58" />
              </identifier>
              <type value="document" />
              <timestamp value="2020-02-03T12:30:02Z" />
              <entry>
                <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Composition/ed52c1e3-b700-4497-ae19-b23744e29876" />
                <resource>
                  <Composition>...</Composition>
                </resource>
              </entry>
              <entry>
                <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/MedicationRequest/e930cdee-9eb5-4b44-88b5-2a18b69f3b9a" />
                <resource>
                  <MedicationRequest>...</MedicationRequest>
                </resource>
              </entry>
              <entry>
                <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Medication/5fe6e06c-8725-46d5-aecd-e65e041ca3de" />
                <resource>
                  <Medication>...</Medication>
                </resource>
              </entry>
              <entry>
                <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Patient/9774f67f-a238-4daf-b4e6-679deeef3811" />
                <resource>
                  <Patient>...</Patient>
                </resource>
              </entry>
             <entry>
                <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Practitioner/20597e0e-cb2a-45b3-95f0-dc3dbdb617c3" />
                <resource>
                  <Practitioner>...</Practitioner>
                </resource>
              </entry>
              <entry>
                <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Organization/cf042e44-086a-4d51-9c77-172f9a972e3b" />
                <resource>
                  <Organization>...</Organization>
                </resource>
              </entry>
              <entry>
                <fullUrl value="http://pvs.praxis-topp-gluecklich.local/fhir/Coverage/1b1ffb6e-eb05-43d7-87eb-e7818fe9661a" />
                <resource>
                  <Coverage>...</Coverage>
                </resource>
              </entry>
              <signature>
                <type>
                  <coding>
                    <system value="http://hl7.org/fhir/ValueSet/signature-type" /> 
                    <code value="1.2.840.10065.1.12.1.1" />
                  </coding>
                </type>
                <when value="2020-02-03T12:32:00Z"/>
                <who>
                  <reference value="urn:uuid:20597e0e-cb2a-45b3-95f0-dc3dbdb617c3" />
                </who>
                <data>
                  MIIIFQYJKoZIhvcNAQcCoIIIBjCCCAICAQExDzANBglghkgBZQMEAgEFADALBgkqhkiG9w0BBwGgggUYMIIFFDCCA/ygAwIBAgIHAVcOPSLLyDANBgkqhkiG9w0BAQsFADBQMQswCQYDVQQGEwJERTEfMB0GA1UECgwWZ2VtYXRpayBHbWJIIE5PVC1WQUxJRDEgMB4GA1UEAwwXR0VNLkhCQS1xQ0EyNCBURVNULU9OTFkwHhcNMTgwMzI5MDAwMDAwWhcNMjMwMzI4MjM1OTU5WjBxMSAwHgYDVQQDDBdTaWdyaWQgQWRhbWnDp1RFU1QtT05MWTEPMA0GA1UEKgwGU2lncmlkMRAwDgYDVQQEDAdBZGFtacOnMR0wGwYDVQQFExQ4MDI3Njg4MzExMDAwMDA5NDgxMjELMAkGA1UEBhMCREUwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCnfkHF12U7c/oeszDMGxX3tVbjSmNI7MghDapRfwmqcTkDUYxMTV8KDWW3YcqlckoQ8oXBNtKvd9QY1mwHdeReCqTtNGYiEMoRnB8XfvLo56y8c4bqEgWqTyUYHC9WvoySTwOvl0oWyS9taoeaQFpRdBSjusYY+8dJkP9DX/gHr9KwRKxYeKt+gpwoyuZE/yoOodxttcx1TdHAFm8cdzG5d1BquYTqIvfWGAtFykyvsxJkpOXEQ56jqx8gbTcsrhJllxIpY0i2sNQVMe/q9OGS3JyriIpfwZa77ljWeomdMvi0zEGPj8X7Vt8NiBkxCFk2y8Q9zDgb3Yvxo1em6PBhAgMBAAGjggHQMIIBzDAdBgNVHQ4EFgQUwRMJSPLHm5kZwk9x/V3+vueO4ZswDAYDVR0TAQH/BAIwADCBlAYFKyQIAwMEgYowgYekKDAmMQswCQYDVQQGEwJERTEXMBUGA1UECgwOZ2VtYXRpayBCZXJsaW4wWzBZMFcwVTAnDCVQc3ljaG9sb2dpc2NoZS8tciBQc3ljaG90aGVyYXBldXQvLWluMAkGByqCFABMBC4THzQtSEJBLVRlc3RrYXJ0ZS04ODMxMTAwMDAwOTQ4MTIwGwYJKwYBBAHAbQMFBA4wDAYKKwYBBAHAbQMFATAiBggrBgEFBQcBAwQWMBQwCAYGBACORgEBMAgGBgQAjkYBBDAfBgNVHSMEGDAWgBRnnDG26cA36h0bgeek9TvMHhcBOTBHBgNVHSAEQDA+MAkGByqCFABMBEgwCQYHBACL7EABAjAYBggqghQATASBETAMMAoGCCsGAQUFBwIBMAwGCisGAQQBgs0zAQEwDgYDVR0PAQH/BAQDAgZAMEsGCCsGAQUFBwEBBD8wPTA7BggrBgEFBQcwAYYvaHR0cDovL29jc3AucGtpLnRlbGVtYXRpay10ZXN0OjgwODAvQ01PQ1NQL09DU1AwDQYJKoZIhvcNAQELBQADggEBAFKBTDYjD/HYGxNoavrWUXAdHkzsJXWTKvXD/uOmXWTSmAZb14XDgZIClDnrDitNx+BCOAovBLv8RlL7YWyWOtdaDRqVS6IUj8se2K0gjrU6BuCojIq370t5cnETjx7jdxiHJh+mVUmbi4dIx2EvYwpK4+2cyHswI8gnwfZml4lDOCW1k62RnyhKc5ndgke/MkamgjVSPVDDvApBI9KU11yuRvsW3x/Ac/6LdSWLt6RiNjVSFImhs9LHFwyrgNM75LX6jgQ7tsOXP3ZUJ5ivmEHyugVEEMer0oU8Axp1y+/Q/0m4uBwQZ9gb7RDiARJCszxJklJ86djt9G/33Tp+56sxggLBMIICvQIBATBbMFAxCzAJBgNVBAYTAkRFMR8wHQYDVQQKDBZnZW1hdGlrIEdtYkggTk9ULVZBTElEMSAwHgYDVQQDDBdHRU0uSEJBLXFDQTI0IFRFU1QtT05MWQIHAVcOPSLLyDANBglghkgBZQMEAgEFAKCCATcwGAYJKoZIhvcNAQkDMQsGCSqGSIb3DQEHATAcBgkqhkiG9w0BCQUxDxcNMjAwMzEyMTQ0MjMxWjAtBgkqhkiG9w0BCTQxIDAeMA0GCWCGSAFlAwQCAQUAoQ0GCSqGSIb3DQEBCwUAMC8GCSqGSIb3DQEJBDEiBCAtN3LfYcqlpQgS/NcvuF9ffpmwXyVtKm9IqW2N6oXPqzCBnAYLKoZIhvcNAQkQAi8xgYwwgYkwgYYwgYMEIHVRn3sG5d7t9/RtbJSZx4MzyY7ud7/p0KUK7ivveRe7MF8wVKRSMFAxCzAJBgNVBAYTAkRFMR8wHQYDVQQKDBZnZW1hdGlrIEdtYkggTk9ULVZBTElEMSAwHgYDVQQDDBdHRU0uSEJBLXFDQTI0IFRFU1QtT05MWQIHAVcOPSLLyDANBgkqhkiG9w0BAQsFAASCAQB5vvdhmI1CgCmOoVqHpmHsdmVoFHid/ZMKsRW70gfnR4EIf+z7bO4QTZNCvHL8N0N1qNfqDXWNlT1ELz5wPFdf+Qoz+Eb8TsUDupxs72l7e+DPG4U4gw8O0uxXiDULMQ1N5ie3XO5gLi7F2g2c+MsK6sRsyxknEnaWvfv8vUbtqbk4C0/O+wChZPThsGqjY8wvcE7QqHiDNVYsSO9/98F+bfF/UUqbmLF/Avi7rUv5THxONKmhWxveyFsClhFVn8JcY/rEjjYC5eG7wxYWv79E2Cn7s+AYIkm1AyW+9xicZBxKnJGpiMoORcEYTd4B+1sjBG7xCpPaFdgTCWdSNh/I
                </data>
              </signature>
            </Bundle>
          </resource>
        </entry>
        <signature>
          <type>
            <coding>
              <system value="http://hl7.org/fhir/ValueSet/signature-type" /> 
              <code value="1.2.840.10065.1.12.1.5" />
            </coding>
          </type>
          <when value="2020-03-20T07:31:34.328+00:00"/>
          <who>
            <reference value="urn:uuid:6b007bdf-c50a-4e69-9db2-6c67092057f6" />
          </who>
          <data>
            QXVmZ3J1bmQgZGVyIENvcm9uYS1TaXR1YXRpb24ga29ubnRlIGhpZXIga3VyemZyaXN0aWcga2VpbiBCZWlzcGllbCBpbiBkZXIgTGFib3J1bWdlYnVuZyBkZXIgZ2VtYXRpayBlcnN0ZWxsdCB3ZWRlbi4gRGllc2VzIHdpcmQgbmFjaGdlcmVpY2h0LgoKSW5oYWx0bGljaCB1bmQgc3RydWt0dXJlbGwgaXN0IGRpZSBTZXJ2ZXJzaWduYXR1ciBkZXIgUXVpdHR1bmcgZWluZSBFbnZlbG9waW5nIENBZEVTLVNpZ25hdHVyLCBkaWUgZGVuIHNpZ25pZXJ0ZW4gRGF0ZW5zYXR6IGFuYWxvZyB6dXIgS29ubmVrdG9yLVNpZ25hdHVyIGlubmVyaGFsYiBkZXMgQVNOMS5Db250YWluZXJzIHRyYW5zcG9ydGllcnQu
          </data>
        </signature>
      </Bundle>
    </resource>
    <search>
      <mode value="include"/>
    </search>
  </entry>
</Bundle>
--------------------------------------
<1> Das im Task enthaltene Secret wird gegen den URL-Parameter `?secret=...` geprüft, damit ausschließlich diejenige Apotheke, für welche das Secret beim Einlösen des E-Rezepts generiert wurde, die Quittung für das belieferte E-Rezept abrufen darf.
<2> Der Status des abgerufenen Tasks ist `completed`, der Workflow des E-Rezepts damit beendet. Der weiter unten im serverseitig signierten Quittungs-Bundle enthaltene Task ist diejenige Version, die während der Erstellung der Quittung gültig war.

s|Code   2+s|Type Success  
|200  2+| No Content +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält die angefragten Daten.#
s|Code   2+s|Type Error   
|400  2+| Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  2+|Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  2+|Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  2+|Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 2+|Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 2+|Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|410 2+|Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 2+|Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  2+|Server Errors +
[small]#Unerwarteter Serverfehler#
|================
