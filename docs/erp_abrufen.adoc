:imagesdir: ../images
:caution-caption: Achtung
:important-caption: Wichtig
:note-caption: Hinweis
:tip-caption: Tip
:warning-caption: Warnung
ifdef::env-github[]
:imagesdir: https://github.com/gematik/api-erp/raw/master/images
:tip-caption: :bulb:
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:caution-caption: :fire:
:warning-caption: :warning:
endif::[]
:toc: macro
:toclevels: 3
:toc-title: Inhaltsverzeichnis
image:gematik_logo.jpg[width=35%] 

= E-Rezept API-Dokumentation für Apotheker
Hier dokumentiert die gematik die Nutzung der Schnittstellen rund um das E-Rezept aus Sicht des abgebenden Leistungserbringers. 

toc::[]

==  Anwendungsfall E-Rezept beliefern
Mit diesem UseCase beliefert ein Apotheker ein E-Rezept, das auf dem E-Rezept-Fachdienst bereitliegt. Eine Unterscheidung zwischen einer Filial- oder Versandapotheke ist dabei zweitrangig, da der Unterschied im Ablauf lediglich in der Übermittlung der `Task-ID` und des `AccessCodes` durch den Versicherten besteht. 
Mit der Bekanntmachung der `Task-ID` und des `AccessCodes` durch den Versicherten mittels Präsentation eines 2D-Barcodes oder via Kommunikationsnachricht liegen im Apothekenverwaltungssystem (AVS) alle notwendigen Parameter für den Abruf des Rezepts vor. +
Ist der Task inkl. des E-Rezept-Datensatzes heruntergeladen, prüft das AVS die Signatur des E-Rezept-Datensatzes mit Hilfe des Konnektors.
Ist das E-Rezept gültig signiert und das E-Rezept beliefert, erfolgt der Abschluss der Transaktion mit dem Bereitstellen der Dispensierinformationen für den Versicherten.
Der E-Rezept-Fachdienst erzeugt daraufhin eine Signatur als Quittung für den Apotheker und den Versicherten und beendet den Workflow.

image:api_rezept_abrufen.png[width=100%]

NOTE: Im Ablaufdiagramm sind zusätzliche Arbeitsschritte des Apothekenpersonals wie Securpharm-Scan und Zuzahlung des Patienten nicht berücksichtigt.

== Profilierung
Für diesen Anwendungsfall werden die FHIR-Resourcen "Task": http://hl7.org/fhir/task.html und MedicationDispense https://www.hl7.org/fhir/medicationdispense.html profiliert.
Die Profile können als JSON oder XML hier eingesehen werden: https://simplifier.net/erezept-workflow/gemerxtask bzw. https://simplifier.net/erezept-workflow/gemerxmedicationdispense

Die für diese Anwendung wichtigen Attribute und Besonderheiten durch die Profilierung der Ressourcen werden in der folgenden Tabelle kurz zusammengefasst: 
|===
|*Name* |*Beschreibung* 
2+s|Task
|identifier:PrescriptionID |Rezept-ID; eindeutig für jedes Rezept 
|identifier:AccessCode |vom E-Rezept-Fachdienst generierter Berechtigungs-Code
|identifier:Secret |vom E-Rezept-Fachdienst generierter Berechtigungs-Code
|status |Status des E-Rezepts 
|intent |Intension des Tasks. Fixer Wert="order" 
|for |Krankenversichertennummer   
|authoredOn |Erstellungszeitpunkt des Tasks
|lastModified |letzte Änderung am Task
|performerType |Institution, in der das Rezept eingelöst werden soll
|input |Verweis auf die für den Patienten und den Leistungserbringer gedachten Bundle
|output |Verweis auf das Quittungs-Bundle
|extension:flowType |gibt den Typ des Rezeptes an
|extension:expiryDate |Verfallsdatum 
|extension:acceptDate |Datum bis zu welchem die Krankenkasse spätestens die Kosten übernimmt
2+s|MedicationDispense
|identifier:PrescriptionID |Rezept-ID; eindeutig für jedes Rezept 
|status |Status des E-Rezepts
|medication |das dem Versicherten ausgehändigte Medikament
|subject:identifier |Krankenversichertennummer
|performer |Telematik-ID der Apotheke, die das E-Rezept beliefert hat
|whenHandedOver |Datum der Übergabe bzw. Herausgabe an den Versicherten
|dosageInstruction |Dosierungsinformationen des Medikaments, falls abweichend von der ärztlichen Verordnung
2+s|Medication innerhalb MedicationDispense
|code |Enthält je nach Rezepttyp die PZN und den Handelsnamen, Kennzeichnung als Wirkstoffverordnung oder eine Rezeptur
|form |Darreichungsform (Tabletten, Kapseln, Salbe, etc.)
|ingredient |Wirkstoff bei Wirkstoffverordnung
|batch |Chargeninformation
|===

In den folgenden Kapiteln wird erläutert, wann und wie die Befüllung dieser Attribute erfolgt.


== E-Rezept abrufen
Ein Apotheker hat vom Versicherten mittels Abscannen eines 2D-Codes die Informationen `https://prescriptionserver.telematik/Task/588780/$accept?ac=777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea` für den Abruf eines E-Rezepts vom E-Rezept-Fachdienst erhalten.

Der Aufruf erfolgt als http-POST-Operation mit der FHIR-Operation `$accept`. Im http-Request-Header `Authorization` muss das während der Authentisierung erhaltene ACCESS_TOKEN übergeben werden. Als URL-Parameter `?ac=...` muss der beim Erzeugen des Tasks generierte `AccessCode` für die Berechtigungsprüfung übergeben werden.
Im http-ResponseBody wird der referenzierte Task sowie das qualifiziert signierte E-Rezept als E-Rezept-Datensatz zurückgegeben, wobei im Task das `secret` als zusätzliches Geheimnis in einem Task.identifier generiert wird, das in allen folgenden Zugriffen durch den Apotheker mitgeteilt werden muss.

*Request*
[cols="h,a"] 
|===
|URI        |https://prescriptionserver.telematik/Task/4711/$accept?ac=777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea
|Method     |POST
|HTTP Header |
----
Content-Type: application/fhir+xml; charset=UTF-8
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J
----
|===


*Response*
[source,xml]
----
HTTP/1.1 200 OK
Content-Type: application/fhir+xml;charset=utf-8

<Bundle xmlns="http://hl7.org/fhir">
  <id value="dffbfd6a-5712-4798-bdc8-07201eb77ab8"/>
  <meta>
    <lastUpdated value="2020-03-13T07:31:34.328+00:00"/>
  </meta>
  <type value="collection"/>
  <entry>
    <fullUrl value="https://prescriptionserver.telematik/Task/4711"/>
    <resource>
      <Task xmlns="http://hl7.org/fhir">
        <id value="4711"/>
        <meta>
          <versionId value="2"/> 
          <source value="#AsYR9plLkvONJAiv"/>
          <profile value="https://gematik.de/fhir/StructureDefinition/ErxTask"/>
        </meta>
        <identifier>
          <use value="official"/>
          <system value="https://gematik.de/fhir/NamingSystem/PrescriptionID"/>
          <value value="160.123.456.789.123.58"/>
        </identifier>
        <identifier>
          <use value="official"/>
          <system value="https://gematik.de/fhir/NamingSystem/AccessCode"/>
          <value value="777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea"/>
        </identifier>
        <identifier>
          <use value="official"/>
          <system value="http://fhir.de/NamingSystem/gkv/kvid-10"/>
          <value value="X123456789"/>
        </identifier>
        <identifier>
          <system value="https://gematik.de/fhir/NamingSystem/Secret"/>
          <value value="c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf"/> <1>
        </identifier>
        <status value="in-progress"/> <2>
        <intent value="order"/> 
        <extension url="https://gematik.de/fhir/StructureDefinition/PrescriptionType">
          <valueCodeableConcept>
            <coding>
                <system value="https://gematik.de/fhir/CodeSystem/Flowtype" />
                <code value="160" />
                <display value="Muster 16 (Apothekenpflichtige Arzneimittel)" />
            </coding>
          </valueCodeableConcept>
        </extension>
        <extension url="https://gematik.de/fhir/StructureDefinition/ExpiryDate">
          <valueDate value="2020-06-02" />
        </extension>
        <extension url="https://gematik.de/fhir/StructureDefinition/AcceptDate">
          <valueDate value="2020-04-01" />
        </extension>
        <authoredOn value="2020-03-02T08:25:05+00:00"/>
        <lastModified value="2020-03-02T08:45:05+00:00"/>
        <performerType>
          <coding>
            <system value="http://terminology.hl7.org/CodeSystem/task-performer-type"/>
            <code value="1.2.276.0.76.4.54"/>
            <display value="Öffentliche Apotheke"/>
          </coding>
          <text value="Apotheke"/>
        </performerType>
        <input> 
          <type> 
            <coding> 
              <system value="https://gematik.de/fhir/CodeSystem/Documenttype"/> 
              <code value="1"/> 
            </coding> 
          </type> 
          <valueReference>
            <reference value="281a985c-f25b-4aae-91a6-41ad744080b0"/> 
          </valueReference> 
        </input> 
      </Task>
    </resource>
    <search>
      <mode value="outcome"/>
    </search>
  </entry>
  <entry>
    <resource>
      <Binary>
        <id value="281a985c-f25b-4aae-91a6-41ad744080b0"/>
        <meta>
          <versionId value="1"/> 
          <source value="#AsYRxq34dvONJAiv"/>
          <profile value="https://gematik.de/fhir/StructureDefinition/ErxBinary"/>
        </meta>
        <contentType value="application/pkcs7-mime" />
        <data value="MIJVqgYJKoZIhvcNAQcCoIJVmzCCVZcCAQExDzAN..." /> <3>
      </Binary>
    </resource>
    <search>
      <mode value="include"/>
    </search>
  </entry>
</Bundle>
----
<1> Dieses generierte `Secret` stellt den Zugriffscode der abrufenden Apotheke dar und muss in allen folgenden Workflowschritten angegeben werden, damit nicht eine fremde Apotheke den Prozess übernehmen kann. 
<2> Der Status des Tasks ist in Bearbeitung (`in-progress`)
<3> Dieses Element enthält den qualifiziert signierten Verordnungsdatensatz als PKCS#7-Datei in Base64-codierter Form. Innerhalb des Signaturobjekts ist das E-Rezept-Bundle enthalten (Enveloping-Signatur) und muss vom Apothekensystem für die Bearbeitung des E-Rezepts verarbeitet werden.



[cols="a,a"] 
|===
s|Code   s|Type Success  
|200  | OK +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält die angefragten Daten.#
s|Code   s|Type Error   
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|409 |Conflict +
[small]#Die Anfrage wurde unter falschen Annahmen gestellt. Das E-Rezept befindet sich bereits in Belieferung#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===

== Qualifizierte Signatur des E-Rezepts prüfen
Im Apothekenverwaltungssystem liegen nach dem Abruf aus dem E-Rezept-Fachdienst der Task des Workflows und der qualifiziert signierte Verordnungsdatensatz vor. Die Rechtmäßigkeit der elektronischen Verordnung wird mittels Prüfung der QES durch den Konnektor verifiziert. Nur bei gültiger qualifizierter elektronischer Signatur des E-Rezepts darf der Apotheker mit der Bearbeitung der Verordnung fortfahren. Für die Prüfung wird die soeben heruntergeladene PKCS#7-Datei in Base64-codierter Form an die SOAP-Schnittstelle der Signaturprüfung des Konnektors als http-POST-Operation geschickt.

*Request*
[cols="h,a"] 
|===
|URI        |https://192.168.x.y/Konnektorservice
|Method     |POST
|HTTP Header |
----
Content-Type: text/xml; charset=UTF-8
Content-Length: 1234
----

|Payload    |
[source,xml]
----
<?xml version=\"1.0\" encoding=\"UTF-8\"?>
<S:Envelope xmlns:S=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\">
  <SOAP-ENV:Header/>
  <S:Body>
    <ns10:VerifyDocument 
      xmlns=\"http://www.w3.org/2001/04/xmlenc#\" 
      xmlns:ns10=\"http://ws.gematik.de/conn/SignatureService/v7.4\" 
      xmlns:ns11=\"urn:oasis:names:tc:dss-x:1.0:profiles:SignaturePolicy:schema#\" 
      xmlns:ns12=\"http://ws.gematik.de/conn/ConnectorContext/v2.0\" xmlns:ns13=\"urn:oasis:names:tc:SAML:2.0:assertion\" 
      xmlns:ns14=\"urn:oasis:names:tc:SAML:1.0:assertion\" 
      xmlns:ns2=\"http://www.w3.org/2000/09/xmldsig#\" 
      xmlns:ns3=\"http://ws.gematik.de/conn/CertificateServiceCommon/v2.0\" 
      xmlns:ns4=\"http://uri.etsi.org/01903/v1.3.2#\" 
      xmlns:ns5=\"urn:oasis:names:tc:dss:1.0:core:schema\" 
      xmlns:ns6=\"urn:oasis:names:tc:dss-x:1.0:profiles:verificationreport:schema#\" 
      xmlns:ns7=\"http://uri.etsi.org/02231/v2#\" 
      xmlns:ns8=\"http://ws.gematik.de/conn/ConnectorCommon/v5.0\" 
      xmlns:ns9=\"http://ws.gematik.de/tel/error/v2.0\">
      <ns12:Context>
        <ns8:MandantId>Mandant1</ns8:MandantId>
        <ns8:ClientSystemId>Clientsystem1</ns8:ClientSystemId>
        <ns8:WorkplaceId>Arbeitsplatz1</ns8:WorkplaceId>
        <ns8:UserId>Möller</ns8:UserId>
      </ns12:Context>
      <ns10:TvMode>NONE</ns10:TvMode>
      <ns10:OptionalInputs>
        <ns6:ReturnVerificationReport>
          <ns6:IncludeVerifier>false</ns6:IncludeVerifier>
          <ns6:IncludeCertificateValues>true</ns6:IncludeCertificateValues>
          <ns6:IncludeRevocationValues>true</ns6:IncludeRevocationValues>
          <ns6:ExpandBinaryValues>false</ns6:ExpandBinaryValues>
          <ns6:ReportDetailLevel>urn:oasis:names:tc:dss-x:1.0:profiles:verificationreport:reportdetail:allDetails</ns6:ReportDetailLevel>
        </ns6:ReturnVerificationReport>
      </ns10:OptionalInputs>
      <ns10:SignatureObject>
          <ns5:Base64Signature 
            Type=\"urn:ietf:rfc:5652\">MIJVqgYJKoZIhvcNAQcCoIJVmzCCVZcCAQExDzAN...</ns5:Base64Signature> <1>
        </ns10:SignatureObject>
      <ns10:IncludeRevocationInfo>false</ns10:IncludeRevocationInfo>
    </ns10:VerifyDocument>
  </S:Body>
</S:Envelope>
----
<1> Dieses Element enthält das Signaturelement inkl. des signierten E-Rezept-Datensatzes (CAdES-enveloping) als PKCS#7-Datei in Base64-Codierung (Darstellung gekürzt).

|===

NOTE: Ein vollständiges Beispiel findet sich im Verzeichnis `samples` mit der Datei `KBV-FHIR-Verordnung.xml`, die für die QES-Erstellung an den Konnektor gesendet wird und dem Signaturergebnis `KBV-FHIR-Verordnung.xml.p7s` entspricht.

*Response*
[source,xml]
----
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
  <SOAP-ENV:Header/>
  <SOAP-ENV:Body>
    <ns11:VerifyDocumentResponse xmlns:ns10="http://uri.etsi.org/02231/v2#" xmlns:ns11="http://ws.gematik.de/conn/SignatureService/v7.4" xmlns:ns12="urn:oasis:names:tc:dss-x:1.0:profiles:SignaturePolicy:schema#" xmlns:ns2="http://ws.gematik.de/conn/nfds/NFDService/v1.0" xmlns:ns3="http://ws.gematik.de/tel/error/v2.0" xmlns:ns4="http://ws.gematik.de/conn/ConnectorCommon/v5.0" xmlns:ns5="http://ws.gematik.de/conn/ConnectorContext/v2.0" xmlns:ns6="urn:oasis:names:tc:dss:1.0:core:schema" xmlns:ns7="http://www.w3.org/2000/09/xmldsig#" xmlns:ns8="urn:oasis:names:tc:dss-x:1.0:profiles:verificationreport:schema#" xmlns:ns9="http://uri.etsi.org/01903/v1.3.2#">
      <ns4:Status>
        <ns4:Result>Warning</ns4:Result>
        <ns3:Error>
          <ns3:MessageID>a7d08b2c-3716-c570-a5f7-87d655984e4f</ns3:MessageID>
          <ns3:Timestamp>2020-07-10T06:07:53.958Z</ns3:Timestamp>
          <ns3:Trace>
            <ns3:EventID>94093be6-d114-437a-ea1e-f38572a44981</ns3:EventID>
            <ns3:Instance>Konnektor-Lokal</ns3:Instance>
            <ns3:LogReference/>
            <ns3:CompType>Konnektor:PKI</ns3:CompType>
            <ns3:Code>1039</ns3:Code>
            <ns3:Severity>Warning</ns3:Severity>
            <ns3:ErrorType>Security</ns3:ErrorType>
            <ns3:ErrorText>Warnung, dass Offline-Modus aktiviert ist und keine OCSP-Statusabfrage durchgeführt wurde</ns3:ErrorText>
          </ns3:Trace>
        </ns3:Error>
      </ns4:Status>
      <ns11:VerificationResult>
        <ns11:HighLevelResult>INCONCLUSIVE</ns11:HighLevelResult>
        <ns11:TimestampType>SIGNATURE_EMBEDDED_TIMESTAMP</ns11:TimestampType>
        <ns11:Timestamp>2020-07-10T06:07:04Z</ns11:Timestamp>
      </ns11:VerificationResult>
      <ns11:OptionalOutputs>
        <ns8:VerificationReport>
          <ns6:VerificationTimeInfo>
            <ns6:VerificationTime>2020-07-10T06:07:53Z</ns6:VerificationTime>
          </ns6:VerificationTimeInfo>
          <ns8:IndividualReport>
            <ns8:SignedObjectIdentifier>
              <ns8:SignedProperties>
                <ns8:SignedSignatureProperties>
                  <ns9:SigningTime>2020-07-10T06:07:04Z</ns9:SigningTime>
                </ns8:SignedSignatureProperties>
                <ns8:Other>
                  <ns11:ShortText>KBV-FHIR-Verordnung.xml</ns11:ShortText>
                  <ns11:ReferenceToSignerCertificate>true</ns11:ReferenceToSignerCertificate>
                  <ns11:DisplayableAttributes>
                    <ns11:DisplayableAttribute>
                      <ns11:Key>1.2.840.113549.1.9.3</ns11:Key>
                      <ns11:Value>1.2.840.113549.1.7.1</ns11:Value>
                    </ns11:DisplayableAttribute>
                    <ns11:DisplayableAttribute>
                      <ns11:Key>1.2.840.113549.1.9.4</ns11:Key>
                      <ns11:Value>WD7cl9aJV/FKtNXFYM9CbQ5Ky5Tp59z4WZ6dxTlqrCM=</ns11:Value>
                    </ns11:DisplayableAttribute>
                  </ns11:DisplayableAttributes>
                </ns8:Other>
              </ns8:SignedProperties>
              <ns7:SignatureValue Id="eb7fb46abfbeec0762734d0167ceadaffc8102dd8cd7aa980bf0471265b4f5e2">VfhGAnLeWOz/Ea/nOdI/vRdnGo5UolafZGlKJiSR/5oMXCvgQCAE9oVSm7SRpluFhAWtMKALllncsAh8E2QTH8kHG1Ti1kl8qRDBWIOmFI61qQvP09gqX7yW1A2oVOIzR7gFJWGoIFvKETXd3fz76BplPiU3sHkyrEd8w65UUMlYLjOScbpeD8owb28mYOBoLFwyO07nqgsQBrWME9r88cM2+214EZv58CYlBaTnkvRmKebqzeNbs6mhR6lVIVv0X17ab58KTLi5SaJ3eZCLVmr1USeV3xr7K2CHhAFgZ3NSAQ50AgpGPqLK/BFeTYFhhemXEwugX0poygrOFNw3Cg==</ns7:SignatureValue>
            </ns8:SignedObjectIdentifier>
            <ns6:Result>
              <ns6:ResultMajor>urn:oasis:names:tc:dss:1.0:resultmajor:InsufficientInformation</ns6:ResultMajor>
              <ns6:ResultMinor>urn:oasis:names:tc:dss:1.0:resultminor:OcspNotAvailiable</ns6:ResultMinor>
              <ns6:ResultMessage xml:lang="DE">Der Offline-Modus ist aktiviert und daher konnte keine OCSP-Statusabfrage durchgeführt werden</ns6:ResultMessage>
            </ns6:Result>
            <ns8:Details>
              <ns6:VerificationTimeInfo>
                <ns6:VerificationTime>2020-07-10T06:07:04Z</ns6:VerificationTime>
              </ns6:VerificationTimeInfo>
              <ns8:DetailedSignatureReport>
                <ns8:FormatOK>
                  <ns8:ResultMajor>urn:oasis:names:tc:dss:1.0:detail:valid</ns8:ResultMajor>
                </ns8:FormatOK>
                <ns8:SignatureOK>
                  <ns8:SigMathOK>
                    <ns8:ResultMajor>urn:oasis:names:tc:dss:1.0:detail:valid</ns8:ResultMajor>
                  </ns8:SigMathOK>
                  <ns8:SignatureAlgorithm>
                    <ns8:Algorithm>http://www.w3.org/2007/05/xmldsig-more#sha256-rsa-MGF1</ns8:Algorithm>
                    <ns8:Suitability>
                      <ns8:ResultMajor>urn:oasis:names:tc:dss:1.0:detail:valid</ns8:ResultMajor>
                    </ns8:Suitability>
                  </ns8:SignatureAlgorithm>
                </ns8:SignatureOK>
                <ns8:CertificatePathValidity>
                  <ns8:PathValiditySummary>
                    <ns8:ResultMajor>urn:oasis:names:tc:dss:1.0:detail:indetermined</ns8:ResultMajor>
                  </ns8:PathValiditySummary>
                  <ns8:CertificateIdentifier>
                    <ns7:X509IssuerName>CN=GEM.HBA-qCA5:PN TEST-ONLY,OU=HBA-qCA der Telematikinfrastruktur mit Anbieterakkreditierung,O=gematik GmbH NOT-VALID,C=DE</ns7:X509IssuerName>
                    <ns7:X509SerialNumber>969179378191040</ns7:X509SerialNumber>
                  </ns8:CertificateIdentifier>
                  <ns8:PathValidityDetail>
                    <ns8:CertificateValidity>
                      <ns8:CertificateIdentifier>
                        <ns7:X509IssuerName>CN=GEM.HBA-qCA5:PN TEST-ONLY,OU=HBA-qCA der Telematikinfrastruktur mit Anbieterakkreditierung,O=gematik GmbH NOT-VALID,C=DE</ns7:X509IssuerName>
                        <ns7:X509SerialNumber>969179378191040</ns7:X509SerialNumber>
                      </ns8:CertificateIdentifier>
                      <ns8:Subject>C=DE,GIVENNAME=Christian+SURNAME=Gõdofský+SERIALNUMBER=80276883110000014330+CN=Christian GõdofskýTEST-ONLY</ns8:Subject>
                      <ns8:ChainingOK>
                        <ns8:ResultMajor>urn:oasis:names:tc:dss:1.0:detail:valid</ns8:ResultMajor>
                      </ns8:ChainingOK>
                      <ns8:ValidityPeriodOK>
                        <ns8:ResultMajor>urn:oasis:names:tc:dss:1.0:detail:valid</ns8:ResultMajor>
                      </ns8:ValidityPeriodOK>
                      <ns8:ExtensionsOK>
                        <ns8:ResultMajor>urn:oasis:names:tc:dss:1.0:detail:valid</ns8:ResultMajor>
                      </ns8:ExtensionsOK>
                      <ns8:CertificateValue>MIIFojCCBIqgAwIBAgIHA....</ns8:CertificateValue>
                      <ns8:SignatureOK>
                        <ns8:SigMathOK>
                          <ns8:ResultMajor>urn:oasis:names:tc:dss:1.0:detail:valid</ns8:ResultMajor>
                        </ns8:SigMathOK>
                        <ns8:SignatureAlgorithm>
                          <ns8:Algorithm>http://www.w3.org/2001/04/xmldsig-more#rsa-sha256</ns8:Algorithm>
                          <ns8:Suitability>
                            <ns8:ResultMajor>urn:oasis:names:tc:dss:1.0:detail:valid</ns8:ResultMajor>
                          </ns8:Suitability>
                        </ns8:SignatureAlgorithm>
                      </ns8:SignatureOK>
                      <ns8:CertificateStatus>
                        <ns8:CertStatusOK>
                          <ns8:ResultMajor>urn:oasis:names:tc:dss:1.0:detail:indetermined</ns8:ResultMajor>
                        </ns8:CertStatusOK>
                      </ns8:CertificateStatus>
                    </ns8:CertificateValidity>
                    <ns8:CertificateValidity>
                      <ns8:CertificateIdentifier>
                        <ns7:X509IssuerName>CN=TSYSI.HBA-qRCA1:PN TEST-ONLY,OU=HBA-qCA - TI der Gesundheitskarte mit Anbieterakkreditierung,O=T-Systems International GmbH NOT-VALID,C=DE</ns7:X509IssuerName>
                        <ns7:X509SerialNumber>8</ns7:X509SerialNumber>
                      </ns8:CertificateIdentifier>
                      <ns8:Subject>C=DE,O=gematik GmbH NOT-VALID,OU=HBA-qCA der Telematikinfrastruktur mit Anbieterakkreditierung,CN=GEM.HBA-qCA5:PN TEST-ONLY</ns8:Subject>
                      <ns8:ChainingOK>
                        <ns8:ResultMajor/>
                      </ns8:ChainingOK>
                      <ns8:ValidityPeriodOK>
                        <ns8:ResultMajor>urn:oasis:names:tc:dss:1.0:detail:valid</ns8:ResultMajor>
                      </ns8:ValidityPeriodOK>
                      <ns8:ExtensionsOK>
                        <ns8:ResultMajor/>
                      </ns8:ExtensionsOK>
                      <ns8:CertificateValue>MIIEujCCA6KgAwIBAg...</ns8:CertificateValue>
                      <ns8:SignatureOK>
                        <ns8:SigMathOK>
                          <ns8:ResultMajor/>
                        </ns8:SigMathOK>
                      </ns8:SignatureOK>
                      <ns8:CertificateStatus>
                        <ns8:CertStatusOK>
                          <ns8:ResultMajor/>
                        </ns8:CertStatusOK>
                      </ns8:CertificateStatus>
                    </ns8:CertificateValidity>
                    <ns8:TrustAnchor>
                      <ns8:ResultMajor>urn:oasis:names:tc:dss:1.0:detail:valid</ns8:ResultMajor>
                      <ns8:ResultMinor>urn:oasis:names:tc:dss-x:1.0:profiles:verificationreport:trustanchor:certDataBase</ns8:ResultMinor>
                    </ns8:TrustAnchor>
                  </ns8:PathValidityDetail>
                </ns8:CertificatePathValidity>
              </ns8:DetailedSignatureReport>
            </ns8:Details>
          </ns8:IndividualReport>
        </ns8:VerificationReport>
      </ns11:OptionalOutputs>
    </ns11:VerifyDocumentResponse>
  </SOAP-ENV:Body>
</SOAP-ENV:Envelope>
----
NOTE: Ein vollständiges Beispiel der Response findet sich im Verzeichnis `samples` mit der Datei `VerifyDocumentCadesEnveloping_response.xml`.

[cols="a,a"] 
|===
s|Code   s|Type Success  
|200  |OK  +
[small]#Die Anfrage wurde erfolgreich bearbeitet und das Ergebnis der Anfrage wird in der Antwort übertragen. Das gilt ebenso für Fehler in der Verarbeitung des SOAP-Requests, die als SOAP-Fault zurückgemeldet werden.#
s|Code   s|Type Error   
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|===

== E-Rezept-Abgabe vollziehen
Ein Apotheker hat ein E-Rezept abgerufen und beliefert den Patienten mit dem Medikament. Zum Abschluss des Worflows stellt er dem Versicherten Informationen über das abgegebene Medikament bereit und erhält als Ergebnis eine signierte Quittung, die er in seinen Abrechnungsprozessen gegenüber dem Abrechnungszentrum bzw. der Krankenkasse als Nachweis des ordnungsgemäßen Abschlusses der Transaktion verwenden kann.

Der Aufruf erfolgt als http-POST-Operation mit der FHIR-Operation `$close`. Im http-Request-Header `Authorization` muss das während der Authentisierung erhaltene ACCESS_TOKEN übergeben werden. Als URL-Parameter `?secret=...` muss das beim Abrufen des E-Rezepts im Task generierte `Secret` für die Berechtigungsprüfung übergeben werden. Zusätzlich werden Informationen über das ausgegebene Medikament an den Fachdienst übergeben.
Im http-ResponseBody wird die serverseitig über den Task und das E-Rezept-Bundle erzeugte Signatur als `Quittungs-Bundle`-Ressource zurückgegeben, die dem Apotheker gegenüber der Krankenkasse als Quittung dient.

*Request*
[cols="h,a"] 
|===
|URI        |https://prescriptionserver.telematik/Task/4711/$close?secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf  +
Zum Nachweis als berechtigte Apotheke, die das E-Rezept gerade in Bearbeitung hält, muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden.
|Method     |POST
|HTTP Header |
----
Content-Type: application/fhir+xml; charset=UTF-8
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J <1>
----

<1> Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Apotheker aus, im Token ist seine Rolle enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.

|Payload    |
[source,xml]
----
<MedicationDispense xmlns="http://hl7.org/fhir">  <1>
  <meta>
    <profile value="https://gematik.de/fhir/StructureDefinition/ErxMedicationDispense" />
  </meta>
  <contained> 
    <Medication> <2>
      <id value="med0314"/> 
      <meta>
        <profile value="https://fhir.kbv.de/StructureDefinition/KBV_PR_ERP_Medikament_PZN\|1.0.0" />
      </meta>
      <extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_Category">
          <valueCoding>
            <system value="http://fhir.de/CodeSystem/ifa/pzn" />
            <code value="06313728" />
          </valueCoding>
      </extension>
      <extension url="https://fhir.kbv.de/StructureDefinition/KBV_EX_ERP_Medication_Vaccine">
        <valueBoolean value="false" />
      </extension>
      <code>
        <coding>
          <system value="http://fhir.de/CodeSystem/ifa/pzn" />
          <code value="06313728" />
        </coding>
        <text value="Sumatriptan-1a Pharma 100 mg Tabletten" />
      </code>
      <form>
        <coding>
          <system value="https://fhir.kbv.de/CodeSystem/KBV_CS_SFHIR_KBV_DARREICHUNGSFORM" />
          <code value="TAB" />
        </coding>
      </form>
      <amount>
        <numerator>
          <value value="12" />
          <unit value="{tbl}" />
          <system value="http://unitsofmeasure.org" />
        </numerator>
        <denominator>
          <value value="1" />
        </denominator>
      </amount> 
    </Medication> 
  </contained> 
  <identifier>
    <system value="https://gematik.de/fhir/NamingSystem/PrescriptionID" />
    <value value="160.123.456.789.123.58" />
  </identifier>
  <status value="completed"/> 
  <medicationReference> 
    <reference value="#med0314"/> 
    <display value="Sumatriptan-1a Pharma 100 mg Tabletten"/> 
  </medicationReference>
  <subject>
    <identifier>
      <system value="http://fhir.de/NamingSystem/gkv/kvid-10" />
      <value value="x1234567" />
    </identifier>
  </subject>
  <performer>
    <actor>
      <identifier>
        <system value="https://gematik.de/fhir/NamingSystem/TelematikID" />
        <value value="606358757" />
      </identifier>
    </actor>
  </performer>
  <whenHandedOver value="2020-03-20T07:13:00+05:00"/> <3>
  <dosageInstruction>
    <text value="1-0-1-0" /> <4>
  </dosageInstruction> 
</MedicationDispense> 
----
<1> Mit der Übergabe der MedicationDispense signalisiert der Apotheker den Abschluss des E-Rezept-Workflows. Der Versicherte erhält Informationen über das abgegebene Medikament.
<2> Sofern kein Austausch des verordneten Medikaments erfolgte, können die Medikations-Informationen aus dem E-Rezept übernommen werden, beim Austausch gegen ein anderes Medikament müssen hier die entsprechenden Informationen angepasst werden, ebenso etwaig abweichende Dosierinformationen.
<3> Die Zeitangabe bezieht sich auf die Übergabe des Medikaments, wann wurde es dem Überbringer des E-Rezepts ausgehändigt.
<4> Die Codierung der Einnahmehinweise erfolgt z.B. in Textform [morgens-mittags-abends-nachts] in boolescher Notation 1=ja, 0=nein

|===

*Response*
[source,xml]
----
HTTP/1.1 200 OK
<Bundle xmlns="http://hl7.org/fhir"> <1>
    <id value="dffbfd6a-5712-4798-bdc8-07201eb77ab8"/>
    <meta>
        <profile value="https://gematik.de/fhir/StructureDefinition/ErxReceipt" />
        <tag>
            <display value="ePrescription receipt" />
        </tag>
    </meta>
    <identifier>
        <system value="https://gematik.de/fhir/NamingSystem/PrescriptionID" />
        <value value="160.123.456.789.123.58" /> <2>
    </identifier>
    <type value="document" />
    <timestamp value="2020-03-20T07:31:34.328+00:00" />
    <entry>
        <fullUrl value="https://prescriptionserver.telematik/Composition/example" />
        <resource>
            <Composition>
                <meta>
                    <profile value="https://gematik.de/fhir/StructureDefinition/ErxComposition" />
                </meta>
                <extension url="https://gematik.de/fhir/StructureDefinition/BeneficiaryExtension"> <3>
                    <valueIdentifier>
                        <system value="https://gematik.de/fhir/NamingSystem/TelematikID" />
                        <value value="606358757" />
                    </valueIdentifier>
                </extension>
                <status value="final" />
                <type>
                    <coding>
                        <system value="https://gematik.de/fhir/CodeSystem/Documenttype" />
                        <code value="3" />
                    </coding>
                </type>
                <date value="2020-03-20T07:31:34.328+00:00" />
                <author>
                    <reference value="https://prescriptionserver.telematik/Device/ErxService" />
                </author>
                <title value="Quittung" />
                <event>
                    <period>
                        <start value="2020-03-20T07:23:34.328+00:00" /> <4>
                        <end value="2020-03-20T07:31:34.328+00:00" /> <5>
                    </period>
                </event>
            </Composition>
        </resource>
    </entry>
    <entry>
        <fullUrl value="https://prescriptionserver.telematik/Device/ErxService" /> <6>
        <resource>
            <Device>
                <id value="eRxService" />
                <meta>
                    <profile value="https://gematik.de/fhir/StructureDefinition/ErxDevice" />
                </meta>
                <status value="active" />
                <serialNumber value="R4.0.0.287342834" />
                <deviceName>
                    <name value="E-Rezept-Fachdienst" />
                    <type value="user-friendly-name" />
                </deviceName>
                <version>
                    <value value="1.0.0" />
                </version>
            </Device>
        </resource>
    </entry>
    <signature> <7>
        <type>
            <system value="urn:iso-astm:E1762-95:2013" />
            <code value="1.2.840.10065.1.12.1.1" />
        </type>
        <when value="2020-03-20T07:31:34.328+00:00" />
        <who>
            <reference value="https://prescriptionserver.telematik/Device/ErxService" />
        </who>
        <sigFormat value="application/pkcs7-mime" />
        <data value="QXVmZ3J1bmQgZGVyIENvcm9uYS1TaXR1YXRpb24ga29ubnRlIGhpZXIga3VyemZyaXN0aWcga2VpbiBCZWlzcGllbCBpbiBkZXIgTGFib3J1bWdlYnVuZyBkZXIgZ2VtYXRpayBlcnN0ZWxsdCB3ZWRlbi4gRGllc2VzIHdpcmQgbmFjaGdlcmVpY2h0LgoKSW5oYWx0bGljaCB1bmQgc3RydWt0dXJlbGwgaXN0IGRpZSBTZXJ2ZXJzaWduYXR1ciBkZXIgUXVpdHR1bmcgZWluZSBFbnZlbG9waW5nIENBZEVTLVNpZ25hdHVyLCBkaWUgZGVuIHNpZ25pZXJ0ZW4gRGF0ZW5zYXR6IGFuYWxvZyB6dXIgS29ubmVrdG9yLVNpZ25hdHVyIGlubmVyaGFsYiBkZXMgQVNOMS5Db250YWluZXJzIHRyYW5zcG9ydGllcnQu" />
    </signature>
</Bundle>
----
<1> Im Ergebnis der Operation wird ein signiertes Bundle als Nachweis des ordnungsgemäßen Durchlaufs des E-Rezept-Workflows zurückgegeben.
<2> Das signierte Quittungs-Bundle enthält die Rezept-ID für eine eindeutige Zuordnung aller Artefakte des durchlaufenen Workflows
<3> An dieser Stelle ist die Telematik-ID als Quittungsempfänger bzw. begünstigte Institution eingetragen, welche die Dispensierung des E-Rezepts vollzogen hat. 
<4> Das Startdatum entspricht dem Abrufdatum des E-Rezepts durch die Apotheke (Statuswechsel des Task: ready -> in-progress)
<5> Signaturzeitpunkt der Quittung, identisch zum Statuswechsel des Task in-prtogress -> completed
<6> Das hier eingebettete Device identifiziert den E-Rezept-Fachdienst als Aussteller der Quittung.
<7> Dieses Element enthält die Signatur des Quittungs-Bundles über alle enthaltenen Objekte als Enveloping CAdES-Signatur in Base64-Codierung.



[cols="a,a"] 
|===
s|Code   s|Type Success  
|200  | OK +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die angeforderte Ressource wurde vor dem Senden der Antwort erstellt. Das „Location“-Header-Feld enthält die Adresse der erstellten Ressource.#
s|Code   s|Type Error   
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|409 |Conflict +
[small]#Die Anfrage wurde unter falschen Annahmen gestellt. Das E-Rezept befindet sich bereits in Belieferung#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===


== E-Rezept zurückweisen
Ein Apotheker hat im vorherigen Schritt ein E-Rezept abgerufen und fachlich geprüft. Er kommt zu dem Schluss, das E-Rezept nicht zu beliefern und möchte nun das E-Rezept zurückweisen, damit der Versicherte das E-Rezept ggfs. in einer anderen Apotheke einlösen kann.

Der Aufruf erfolgt als http-POST-Operation mit der FHIR-Operation `$reject`. Im http-Request-Header `Authorization` muss das während der Authentisierung erhaltene ACCESS_TOKEN übergeben werden. Als URL-Parameter `?secret=...` muss das beim Abrufen des E-Rezepts im Task generierte `Secret` für die Berechtigungsprüfung übergeben werden.

*Request*
[cols="h,a"] 
|===
|URI        |https://prescriptionserver.telematik/Task/4711/$reject?secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf  +  
Zum Nachweis als berechtigte Apotheke, die das E-Rezept gerade in Bearbeitung hält, muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden
|Method     |POST
|HTTP Header |
----
Content-Type: application/fhir+xml; charset=UTF-8;
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J <1>
----
<1> Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Apotheker aus, im Token ist seine Rolle enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt.
|===

*Response*
[source,xml]
----
HTTP/1.1 204 No Content  <1>
----
<1> Im Ergebnis der $reject-Operation wird der referenzierte Task auf den aktiven Status `ready` zurückgesetzt und das Secret gelöscht. Dementsprechend werden keine Daten an den aufrufenden Client zurückgegeben.


[cols="a,a"] 
|===
s|Code   s|Type Success  
|204  | No Content +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält jedoch keine Daten.#
s|Code   s|Type Error   
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===


== E-Rezept löschen
Ein Apotheker hat im vorherigen Schritt ein E-Rezept abgerufen und fachlich geprüft. Der Versicherte bittet ihn jedoch, das Rezept nicht zu beliefern sondern zu löschen, da er nicht über ein eigenes Gerät mit E-Rezept-App verfügt aber sein Recht auf informationelle Selbstbestimmung wahrnehmen möchte. Der Apotheker kommt diesem Wunsch nach und löscht das E-Rezept auf dem Fachdienst.

Der Aufruf erfolgt als http-POST-Operation mit der FHIR-Operation `$abort`. Im http-Request-Header `Authorization` muss das während der Authentisierung erhaltene ACCESS_TOKEN übergeben werden. Als URL-Parameter `?secret=...` muss das beim Abrufen des E-Rezepts im Task generierte `Secret` für die Berechtigungsprüfung übergeben werden.

*Request*
[cols="h,a"] 
|===
|URI        |https://prescriptionserver.telematik/Task/4711/$abort?secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf  +
Zum Nachweis als berechtigte Apotheke, die das E-Rezept gerade in Bearbeitung hält, muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden
|Method     |POST
|HTTP Header |
----
Content-Type: application/fhir+xml; charset=UTF-8
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J <1>
----
<1> Mit dem ACCESS_TOKEN im `Authorization`-Header weist sich der Zugreifende als Leistungserbringer aus, im Token ist seine Rolle enthalten. Die Base64-Darstellung des Tokens ist stark gekürzt. 
|===

*Response*
[source,xml]
----
HTTP/1.1 204 No Content <1>
----
<1> Im Ergebnis der $abort-Operation wird der referenzierte Task gelöscht. Dementsprechend werden keine Daten an den aufrufenden Client zurückgegeben.


[cols="a,a"] 
|===
s|Code   s|Type Success  
|204  | No Content +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält jedoch keine Daten.#
s|Code   s|Type Error   
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|409 |Conflict +
[small]#Die Anfrage wurde unter falschen Annahmen gestellt. Das E-Rezept befindet sich bereits in Belieferung#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===


== Quittung erneut abrufen
Als Apotheker kann es erforderlich sein, die Quittung für ein beliefertes E-Rezept erneut abzurufen (z.B. am Monatsende für Abrechnungszwecke, falls das Apothekenverwaltungssystem die Quittung nicht während der Belieferung gespeichert hat). Der Abruf ist möglich, solange das E-Rezept nicht automatisch und auch nicht durch den Versicherten gelöscht wurde.

*Request*
[cols="h,a"] 
|===
|URI        | https://prescriptionserver.telematik/Task/4711?secret=c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf 

Zum Nachweis als berechtigte Apotheke, die das E-Rezept gerade in Bearbeitung hält, muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden
|Method     |GET
|HTTP Header |
----
Authorization: Bearer eyJraWQ.ewogImL2pA10Qql22ddtutrvx4FsDlz.rHQjEmB1lLmpqn9J <1>
----
<1> Zum Nachweis als berechtigte Apotheke, die das E-Rezept verarbeitet hat(te), muss im URL-Parameter `secret` das beim Abrufen generierte Secret übergeben werden 
|===


*Response*
[source,xml]
----
HTTP/1.1 200 
<Bundle xmlns="http://hl7.org/fhir">
  <id value="dffbfd6a-5712-4798-bdc8-07201eb77ab8"/>
  <meta>
    <lastUpdated value="2020-03-13T07:31:34.328+00:00"/>
  </meta>
  <type value="collection"/>
  <entry>
    <fullUrl value="https://prescriptionserver.telematik/Task/4711"/>
    <resource>
      <Task xmlns="http://hl7.org/fhir">
        <id value="4711"/>
        <meta>
          <versionId value="2"/>
          <lastUpdated value="2020-02-18T10:05:05.038+00:00"/>
          <source value="#AsYR9plLkvONJAiv"/>
          <profile value="https://gematik.de/fhir/StructureDefinition/ErxTask"/>
        </meta>
        <identifier>
          <use value="official"/>
          <system value="https://gematik.de/fhir/NamingSystem/PrescriptionID"/>
          <value value="160.123.456.789.123.58"/>
        </identifier>
        <identifier>
          <use value="official"/>
          <system value="https://gematik.de/fhir/NamingSystem/AccessCode"/>
          <value value="777bea0e13cc9c42ceec14aec3ddee2263325dc2c6c699db115f58fe423607ea"/>
        </identifier>
        <identifier>
          <use value="official"/>
          <system value="http://fhir.de/NamingSystem/gkv/kvid-10"/>
          <value value="X123456789"/>
        </identifier>
        <identifier>
          <system value="https://gematik.de/fhir/NamingSystem/Secret"/>
          <value value="c36ca26502892b371d252c99b496e31505ff449aca9bc69e231c58148f6233cf"/>
        </identifier>
        <status value="completed"/>
        <intent value="order"/> 
        <extension url="https://gematik.de/fhir/StructureDefinition/PrescriptionType">
          <valueCodeableConcept>
            <coding>
                <system value="https://gematik.de/fhir/CodeSystem/Flowtype" />
                <code value="160" />
                <display value="Muster 16 (Apothekenpflichtige Arzneimittel)" />
            </coding>
          </valueCodeableConcept>
        </extension>
        <extension url="https://gematik.de/fhir/StructureDefinition/ExpiryDate">
          <valueDateTime value="2020-06-02" />
        </extension>
        <extension url="https://gematik.de/fhir/StructureDefinition/AcceptDate">
          <valueDateTime value="2020-04-01" />
        </extension>
        <authoredOn value="2020-03-02T08:25:05+00:00"/>
        <lastModified value="2020-03-02T08:45:05+00:00"/>
        <performerType>
          <coding>
            <system value="http://terminology.hl7.org/CodeSystem/task-performer-type"/>
            <code value="1.2.276.0.76.4.32"/>
            <display value="Apotheke"/>
          </coding>
          <text value="Apotheke"/>
        </performerType>
        <input> 
          <type> 
            <coding> 
              <system value="https://gematik.de/fhir/CodeSystem/Documenttype"/> 
              <code value="1"/> 
            </coding> 
          </type> 
          <valueString value="281a985c-f25b-4aae-91a6-41ad744080b0"/> 
        </input> 
        <output> 
          <type> 
            <coding> 
              <system value="https://gematik.de/fhir/CodeSystem/Documenttype"/> 
              <code value="3"/> 
            </coding> 
          </type> 
          <valueString value="dffbfd6a-5712-4798-bdc8-07201eb77ab8"/> 
        </output> 
      </Task>
    </resource>
    <search>
      <mode value="outcome"/> <1>
    </search>
  </entry>
  <entry>
    <resource>
      <Bundle xmlns="http://hl7.org/fhir"> <2>
        <id value="dffbfd6a-5712-4798-bdc8-07201eb77ab8"/>
        <meta>
          <profile value="https://gematik.de/fhir/StructureDefinition/ErxReceipt" />
          <tag>
              <display value="ePrescription receipt" />
          </tag>
        </meta>
        <identifier>
          <system value="https://gematik.de/fhir/NamingSystem/PrescriptionID" />
          <value value="160.123.456.789.123.58" />
        </identifier>
        <type value="document" />
        <timestamp value="2020-03-20T07:31:34.328+00:00" />
        <entry>
          <fullUrl value="https://prescriptionserver.telematik/Composition/example" />
          <resource>
            <Composition>
                <meta>
                    <profile value="https://gematik.de/fhir/StructureDefinition/ErxComposition" />
                </meta>
                <extension url="https://gematik.de/fhir/StructureDefinition/BeneficiaryExtension">
                    <valueIdentifier>
                        <system value="https://gematik.de/fhir/Namingsystem/TelematikID" />
                        <value value="606358757" />
                    </valueIdentifier>
                </extension>
                <status value="final" />
                <type>
                    <coding>
                        <system value="https://gematik.de/fhir/CodeSystem/Documenttype" />
                        <code value="3" />
                    </coding>
                </type>
                <date value="2020-03-20T07:31:34.328+00:00" />
                <author>
                    <reference value="https://prescriptionserver.telematik/Device/ErxService" />
                </author>
                <title value="Quittung" />
                <event>
                    <period>
                        <start value="2020-03-20T07:23:34.328+00:00" />
                        <end value="2020-03-20T07:31:34.328+00:00" />
                    </period>
                </event>
            </Composition>
          </resource>
        </entry>
        <entry>
          <fullUrl value="https://prescriptionserver.telematik/Device/ErxService" />
          <resource>
            <Device>
                <id value="eRxService" />
                <meta>
                    <profile value="https://gematik.de/fhir/StructureDefinition/ErxDevice" />
                </meta>
                <status value="active" />
                <serialNumber value="R4.0.0.287342834" />
                <deviceName>
                    <name value="E-Rezept-Fachdienst" />
                    <type value="user-friendly-name" />
                </deviceName>
                <version>
                    <value value="1.0.0" />
                </version>
            </Device>
          </resource>
        </entry>
        <signature>
          <type>
            <system value="urn:iso-astm:E1762-95:2013" />
            <code value="1.2.840.10065.1.12.1.1" />
          </type>
          <when value="2020-03-20T07:31:34.328+00:00" />
          <who>
            <reference value="https://prescriptionserver.telematik/Device/ErxService" />
          </who>
          <sigFormat value="application/pkcs7-mime" />
          <data value="QXVmZ3J1bmQgZGVyIENvcm9uYS1TaXR1YXRpb24ga29ubnRlIGhpZXIga3VyemZyaXN0aWcga2VpbiBCZWlzcGllbCBpbiBkZXIgTGFib3J1bWdlYnVuZyBkZXIgZ2VtYXRpayBlcnN0ZWxsdCB3ZWRlbi4gRGllc2VzIHdpcmQgbmFjaGdlcmVpY2h0LgoKSW5oYWx0bGljaCB1bmQgc3RydWt0dXJlbGwgaXN0IGRpZSBTZXJ2ZXJzaWduYXR1ciBkZXIgUXVpdHR1bmcgZWluZSBFbnZlbG9waW5nIENBZEVTLVNpZ25hdHVyLCBkaWUgZGVuIHNpZ25pZXJ0ZW4gRGF0ZW5zYXR6IGFuYWxvZyB6dXIgS29ubmVrdG9yLVNpZ25hdHVyIGlubmVyaGFsYiBkZXMgQVNOMS5Db250YWluZXJzIHRyYW5zcG9ydGllcnQu" />
        </signature>
      </Bundle>
    </resource>
    <search>
      <mode value="include"/> <3>
    </search>
  </entry>
</Bundle>
----
<1> In der Abfrage wird der Task als Ergebnis der Abfrage zurückgegeben
<2> Die Quittung wird als Objekt zusammen mit dem Task zurückgegeben
<3> Mit dem Ergebnistyp der Abfrage "include" wird kenntlich gemacht, dass die Quittung ergänzend zur Abfrage auf ein anderes Objekt zurückgegebe wird.
 

[cols="a,a"] 
|===
s|Code   s|Type Success  
|200  | No Content +
[small]#Die Anfrage wurde erfolgreich bearbeitet. Die Response enthält die angefragten Daten.#
s|Code   s|Type Error   
|400  | Bad Request  +
[small]#Die Anfrage-Nachricht war fehlerhaft aufgebaut.#
|401  |Unauthorized +
[small]#Die Anfrage kann nicht ohne gültige Authentifizierung durchgeführt werden. Wie die Authentifizierung durchgeführt werden soll, wird im „WWW-Authenticate“-Header-Feld der Antwort übermittelt.#
|403  |Forbidden +
[small]#Die Anfrage wurde mangels Berechtigung des Clients nicht durchgeführt, bspw. weil der authentifizierte Benutzer nicht berechtigt ist.#
|404  |Not found +
[small]#Die adressierte Ressource wurde nicht gefunden, die übergebene ID ist ungültig.#
|405 |Method Not Allowed +
[small]#Die Anfrage darf nur mit anderen HTTP-Methoden (zum Beispiel GET statt POST) gestellt werden. Gültige Methoden für die betreffende Ressource werden im „Allow“-Header-Feld der Antwort übermittelt.#
|408 |Request Timeout +
[small]#Innerhalb der vom Server erlaubten Zeitspanne wurde keine vollständige Anfrage des Clients empfangen.#
|410 |Gone +
[small]#Die angeforderte Ressource wird nicht länger bereitgestellt und wurde dauerhaft entfernt.#
|429 |Too Many Requests +
[small]#Der Client hat zu viele Anfragen in einem bestimmten Zeitraum gesendet.#
|500  |Server Errors +
[small]#Unerwarteter Serverfehler#
|===